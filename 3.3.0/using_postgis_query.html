<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>Chapter 5. 空間クエリ</title><link rel="stylesheet" type="text/css" href="docbook.css"><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="PostGIS 3.3.0 マニュアル"><link rel="up" href="index.html" title="PostGIS 3.3.0 マニュアル"><link rel="prev" href="using_postgis_dbmanagement.html" title="Chapter 4. データ管理"><link rel="next" href="performance_tips.html" title="Chapter 6. 性能向上に関する技法"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 5. 空間クエリ</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="using_postgis_dbmanagement.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="performance_tips.html">Next</a></td></tr></table></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="using_postgis_query"></a>Chapter 5. 空間クエリ</h1></div></div></div><div class="toc"><div class="toc-title">Table of Contents</div><dl class="toc"><dt><span class="sect1"><a href="using_postgis_query.html#eval_spatial_rel">5.1. 空間関係の決定</a></span></dt><dd><dl><dt><span class="sect2"><a href="using_postgis_query.html#DE-9IM">5.1.1. Dimensionally Extended 9-Intersection Model</a></span></dt><dt><span class="sect2"><a href="using_postgis_query.html#named-spatial-rel">5.1.2. 名前付き空間関係</a></span></dt><dt><span class="sect2"><a href="using_postgis_query.html#general-spatial-rel">5.1.3. 一般的な空間関係</a></span></dt></dl></dd><dt><span class="sect1"><a href="using_postgis_query.html#using-query-indexes">5.2. 空間インデックスを使う</a></span></dt><dt><span class="sect1"><a href="using_postgis_query.html#examples_spatial_sql">5.3. 空間SQLの例</a></span></dt></dl></div><p>空間データベースの<span class="emphasis"><em>レゾンデートル</em></span>は、通常ならデスクトップGISの機能が必要なクエリをデータベース内で実行することです。PostGISを使うには、使用可能な空間関数は何かを知り、またクエリ内でどう使うかを知って、適切なインデックスで能率を向上させることが求められます。 </p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="eval_spatial_rel"></a>5.1. 空間関係の決定</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="using_postgis_query.html#DE-9IM">5.1.1. Dimensionally Extended 9-Intersection Model</a></span></dt><dt><span class="sect2"><a href="using_postgis_query.html#named-spatial-rel">5.1.2. 名前付き空間関係</a></span></dt><dt><span class="sect2"><a href="using_postgis_query.html#general-spatial-rel">5.1.3. 一般的な空間関係</a></span></dt></dl></div><p>空間関係は、二つのジオメトリについて、一方がもう一方にどのような相互関係になっているかを示すものです。ジオメトリのクエリにおける基本的な機能です。 </p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="DE-9IM"></a>5.1.1. Dimensionally Extended 9-Intersection Model</h3></div></div></div><p><a class="ulink" href="http://www.opengeospatial.org/standards/sfs" target="_top">OpenGIS Simple Features Implementation Specification for SQL</a>によると「二つのジオメトリの比較の基本的なアプローチは、二つのジオメトリの内部、境界、外部のインタセクションの比較と、『インタセクション行列』の要素に基づく2ジオメトリの関係の分類です」。</p><p>点集合トポロジでは、2次元空間に埋め込まれたジオメトリの中にあるポイントは、次に示す三つの集合に分類されます。 </p><div class="glosslist"><dl><dt><span class="glossterm">境界</span></dt><dd class="glossdef"><p>ジオメトリの境界は、一次元低いジオメトリです。<code class="varname">POINT</code>では、次元が0になり、境界は空集合です。<code class="varname">LINESTRING</code>の境界は二つの端点です。<code class="varname">POLYGON</code>の境界は、外環と内環の線です。</p></dd><dt><span class="glossterm">内部 (Interior)</span></dt><dd class="glossdef"><p>ジオメトリの内部は、ジオメトリの境界以外のポイントです。<code class="varname">POINT</code>では、内部はポイント自体です。<code class="varname">LINESTRING</code>の内部は端点の間のポイントの集合です。<code class="varname">POLYGON</code>の内部は、ポリゴン内部の面です。</p></dd><dt><span class="glossterm">外部 (Exterior)</span></dt><dd class="glossdef"><p>ジオメトリの外部はジオメトリが組み込まれた空間の残りです。言い換えると、ジオメトリの内部にも境界にもない点の全てです。これは2次元の閉じていない面になります。 </p></dd></dl></div><p><a class="ulink" href="http://en.wikipedia.org/wiki/DE-9IM" target="_top">Dimensionally Extended 9-Intersection Model</a> (DE-9IM)は、二つのジオメトリの空間関係を九つの交差の次元を指定することで記述します。交差次元は3×3の<span class="bold"><strong>交差行列</strong></span>で正式に表現することができます。 </p><p>ジオメトリ<span class="emphasis"><em>g</em></span>に対する<span class="emphasis"><em>内部</em></span>、<span class="emphasis"><em>境界</em></span>、<span class="emphasis"><em>外部</em></span>は<span class="emphasis"><em>I(g)</em></span>、<span class="emphasis"><em>B(g)</em></span>、<span class="emphasis"><em>E(g)</em></span>と表記します。また、<span class="emphasis"><em>dim(s)</em></span>は<span class="emphasis"><em>s</em></span>の集合を<code class="literal">{0,1,2,F}</code>の値で示すます。 </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">0</code> =&gt; 点</p></li><li class="listitem"><p><code class="literal">1</code> =&gt; 線</p></li><li class="listitem"><p><code class="literal">2</code> =&gt; 面</p></li><li class="listitem"><p><code class="literal">F</code> =&gt; 空集合</p></li></ul></div><p>この表記法を使うと、二つのジオメトリ<span class="emphasis"><em>a</em></span>と<span class="emphasis"><em>b</em></span>の交差行列は次の通りです。</p><div class="styledtable"><table class="styledtable" style="border-collapse: collapse;border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col><col><col><col></colgroup><thead><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"> </th><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="bold"><strong>内部 (Interior)</strong></span></th><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="bold"><strong>境界 (Boundary)</strong></span></th><th style="border-bottom: 1px solid ; " align="center"><span class="bold"><strong>外部 (Exterior)</strong></span></th></tr></thead><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="bold"><strong>内部 (Interior)</strong></span></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="emphasis"><em>dim( I(a) ∩ I(b) )</em></span></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="emphasis"><em>dim( I(a) ∩ B(b) )</em></span></td><td style="border-bottom: 1px solid ; " align="center"><span class="emphasis"><em>dim( I(a) ∩ E(b) )</em></span></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="bold"><strong>境界 (Boundary)</strong></span></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="emphasis"><em>dim( B(a) ∩ I(b) )</em></span></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center"><span class="emphasis"><em>dim( B(a) ∩ B(b) )</em></span></td><td style="border-bottom: 1px solid ; " align="center"><span class="emphasis"><em>dim( B(a) ∩ E(b) )</em></span></td></tr><tr><td style="border-right: 1px solid ; " align="center"><span class="bold"><strong>外部 (Exterior)</strong></span></td><td style="border-right: 1px solid ; " align="center"><span class="emphasis"><em>dim( E(a) ∩ I(b) )</em></span></td><td style="border-right: 1px solid ; " align="center"><span class="emphasis"><em>dim( E(a) ∩ B(b) )</em></span></td><td style="" align="center"><span class="emphasis"><em>dim( E(a) ∩ E(b) )</em></span></td></tr></tbody></table></div><p>二つのオーバラップするポリゴンについて可視化すると、次のようになります。</p><div class="informaltable"><table class="informaltable" style="border: none;"><colgroup><col width="80pt"><col></colgroup><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; "> </td><td style="border-bottom: 1px solid ; " align="center"><div class="informalfigure"><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;"><tr><td align="center" valign="middle"><img src="images/de9im04.png" align="middle"></td></tr></table></div></div></td></tr><tr><td style="border-right: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div align="center"><table border="0" summary="manufactured viewport for HTML img" style="cellpadding: 0; cellspacing: 0;"><tr><td align="center" valign="middle"><img src="images/de9im03.png" align="middle"></td></tr></table></div></div></td><td style=""><p> </p><div class="styledtable"><table class="styledtable" style="border-collapse: collapse;border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col><col><col><col></colgroup><thead valign="middle"><tr><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"> </th><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><span class="bold"><strong>内部 (Interior)</strong></span></th><th style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><span class="bold"><strong>境界 (Boundary)</strong></span></th><th style="border-bottom: 1px solid ; " align="center" valign="middle"><span class="bold"><strong>外部 (Exterior)</strong></span></th></tr></thead><tbody valign="middle"><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><span class="bold"><strong>内部 (Interior)</strong></span></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im05.png"></div></div><p><span class="emphasis"><em>dim( I(a) ∩ I(b) ) = </em></span><span class="bold"><strong>2</strong></span></p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im06.png"></div></div><p><span class="emphasis"><em>dim( I(a) ∩ B(b) = </em></span><span class="bold"><strong>1</strong></span></p></td><td style="border-bottom: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im07.png"></div></div><p><span class="emphasis"><em>dim( I(a) ∩ E(b) ) = </em></span><span class="bold"><strong>2</strong></span></p></td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><span class="bold"><strong>境界 (Boundary)</strong></span></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im08.png"></div></div><p><span class="emphasis"><em>dim( B(a) ∩ I(b) ) = </em></span><span class="bold"><strong>1</strong></span></p></td><td style="border-right: 1px solid ; border-bottom: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im09.png"></div></div><p><span class="emphasis"><em>dim( B(a) ∩ B(b) ) = </em></span><span class="bold"><strong>0</strong></span></p></td><td style="border-bottom: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im10.png"></div></div><p><span class="emphasis"><em>dim( B(a) ∩ E(b) ) = </em></span><span class="bold"><strong>1</strong></span></p></td></tr><tr><td style="border-right: 1px solid ; " align="center" valign="middle"><span class="bold"><strong>外部 (Exterior)</strong></span></td><td style="border-right: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im11.png"></div></div><p><span class="emphasis"><em>dim( E(a) ∩ I(b) ) = </em></span><span class="bold"><strong>2</strong></span></p></td><td style="border-right: 1px solid ; " align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im12.png"></div></div><p><span class="emphasis"><em>dim( E(a) ∩ B(b) ) = </em></span><span class="bold"><strong>1</strong></span></p></td><td style="" align="center" valign="middle"><div class="informalfigure"><div><img src="images/de9im13.png"></div></div><p><span class="emphasis"><em>dim( E(a) ∩ E(b) = </em></span><span class="bold"><strong>2</strong></span></p></td></tr></tbody></table></div></td></tr></tbody></table></div><p>左から右に、上から下に読みます。交差行列の文字列表現は'<span class="bold"><strong>212101212</strong></span>'です。</p><p>詳細情報については次をご覧下さい。</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p><a class="ulink" href="http://www.opengeospatial.org/standards/sfs" target="_top">OpenGIS Simple Features Implementation Specification for SQL</a> (1.1版, 2.1.13.2節)</p></li><li class="listitem"><p><a class="ulink" href="https://en.wikipedia.org/wiki/DE-9IM" target="_top">Wikipedia: Dimensionally Extended Nine-Intersection Model (DE-9IM)</a></p></li><li class="listitem"><p><a class="ulink" href="http://docs.geotools.org/latest/userguide/library/jts/dim9.html" target="_top">GeoTools: Point Set Theory and the DE-9IM Matrix</a></p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="named-spatial-rel"></a>5.1.2. 名前付き空間関係</h3></div></div></div><p>共通の空間関係を簡単に決定できるように、PGC SFSは<span class="emphasis"><em>名前付き空間関係述語</em></span>の集合を定義しています。PostGISでは<a class="xref" href="ST_Contains.html" title="ST_Contains">ST_Contains</a>、<a class="xref" href="ST_Crosses.html" title="ST_Crosses">ST_Crosses</a>、<a class="xref" href="ST_Disjoint.html" title="ST_Disjoint">ST_Disjoint</a>、<a class="xref" href="ST_Equals.html" title="ST_Equals">ST_Equals</a>、<a class="xref" href="ST_Intersects.html" title="ST_Intersects">ST_Intersects</a>、<a class="xref" href="ST_Overlaps.html" title="ST_Overlaps">ST_Overlaps</a>、<a class="xref" href="ST_Touches.html" title="ST_Touches">ST_Touches</a>、<a class="xref" href="ST_Within.html" title="ST_Within">ST_Within</a>が提供されています。非標準の空間関係述語<a class="xref" href="ST_Covers.html" title="ST_Covers">ST_Covers</a>、<a class="xref" href="ST_CoveredBy.html" title="ST_CoveredBy">ST_CoveredBy</a>、<a class="xref" href="ST_ContainsProperly.html" title="ST_ContainsProperly">ST_ContainsProperly</a>も定義されています。 </p><p>空間述語は通常SQLの<code class="code">WHERE</code>節や<code class="code">JOIN</code>節内で条件に使用されます。名前付き空間述語は、インデックスが有効なら自動的に空間インデックスを使うので、バウンディングボックス演算子<code class="code">&amp;&amp;</code>を使う必要はありません。例えば次のようになります。 </p><pre class="programlisting">SELECT city.name, state.name, city.geom
FROM city JOIN state ON ST_Intersects(city.geom, state.geom);
</pre><p>詳細や図については<a class="ulink" href="https://postgis.net/workshops/postgis-intro/spatial_relationships.html" target="_top">PostGIS Workshop</a>をご覧下さい。</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="general-spatial-rel"></a>5.1.3. 一般的な空間関係</h3></div></div></div><p>名前付き空間関係が求める空間フィルタ条件を与えるのに不十分となる場合があります。 </p><div class="informaltable"><table class="informaltable" style="border: none;"><colgroup><col></colgroup><tbody><tr><td style=""><div class="informalfigure-float" style="float: right;"><div class="informalfigure"><div align="left"><img src="images/de9im01.png" align="left"></div></div></div><p>例えば、道路ネットワークを表現する線データセットを考えてみます。点でなく線で交差する全ての道路の辺を識別しなければならないことがあります (ビジネスルールの検証のためならありえます)。この場合、<a class="xref" href="ST_Crosses.html" title="ST_Crosses">ST_Crosses</a>では、点で交差する場合しか<code class="varname">true</code>を返さないので、必要な空間フィルタになりません。 </p>
                <p>2ステップ解決法を示します。まず、空間的にインタセクトしている同路線の二本を抜き出し (<a class="xref" href="ST_Intersects.html" title="ST_Intersects">ST_Intersects</a>)、実際にインタセクトしている部分を計算 (<a class="xref" href="ST_Intersection.html" title="ST_Intersection">ST_Intersection</a>)します。次いで、インタセクトしている部分の<a class="xref" href="ST_GeometryType.html" title="ST_GeometryType">ST_GeometryType</a>が<code class="varname">LINESTRING</code>' かどうかを確認します (<code class="varname">[MULTI]POINT</code>、<code class="varname">[MULTI]LINESTRING</code>等の<code class="varname">GEOMETRYCOLLECTION</code>を返す場合に適切に処理します)。</p>
                <p>明らかに、より単純でより速い解法が望ましいです。</p></td></tr></tbody></table></div><div class="informaltable"><table class="informaltable" style="border: none;"><colgroup><col></colgroup><tbody><tr><td style=""><p> </p><div class="informalfigure-float" style="float: right;"><div class="informalfigure"><div align="right"><img src="images/de9im02.png" align="right"></div></div></div> <p>二つ目の例では、湖の境界とインタセクトし、かつ終端が岸に上がっている波止場を見つけます。言い換えると、波止場が湖に含まれるが完全には含まれず、湖の境界線とインタセクトして、波止場の終端が確実に湖内または境界にある場合を指します。空間述語を併用すると求める地物を見つけることができます。</p> <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><a class="xref" href="ST_Contains.html" title="ST_Contains">ST_Contains</a>(lake, wharf) = TRUE</p></li><li class="listitem"><p><a class="xref" href="ST_ContainsProperly.html" title="ST_ContainsProperly">ST_ContainsProperly</a>(lake, wharf) = FALSE</p></li><li class="listitem"><p><a class="xref" href="ST_GeometryType.html" title="ST_GeometryType">ST_GeometryType</a>(<a class="xref" href="ST_Intersection.html" title="ST_Intersection">ST_Intersection</a>(wharf, lake)) = 'LINESTRING'</p></li><li class="listitem"><p><a class="xref" href="ST_NumGeometries.html" title="ST_NumGeometries">ST_NumGeometries</a>(<a class="xref" href="ST_Multi.html" title="ST_Multi">ST_Multi</a>(<a class="xref" href="ST_Intersection.html" title="ST_Intersection">ST_Intersection</a>(<a class="xref" href="ST_Boundary.html" title="ST_Boundary">ST_Boundary</a>(wharf), <a class="xref" href="ST_Boundary.html" title="ST_Boundary">ST_Boundary</a>(lake)))) = 1</p><p>… 言うまでもないですが非常に複雑ですね。</p></li></ul></div></td></tr></tbody></table></div><p>この要件は完全なDE-9IM交差行列の計算で満たすことができます。PostGISは、これを行う<a class="xref" href="ST_Relate.html" title="ST_Relate">ST_Relate</a>関数を提供しています。次のようにします。 </p><pre class="programlisting">SELECT ST_Relate( 'LINESTRING (1 1, 5 5)',
                  'POLYGON ((3 3, 3 7, 7 7, 7 3, 3 3))' );
st_relate
-----------
1010F0212
</pre><p>特定の空間関係をテストするには、<span class="bold"><strong>交差行列パターン</strong></span>を使います。これは、追加シンボル<code class="literal">{T,*}</code>で拡張された行列表現です。 </p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">T</code> =&gt; インタセクションの次元は空ではないという意味です。すなわち<code class="literal">{0,1,2}</code>のいずれかです。</p></li><li class="listitem"><p><code class="literal">*</code> =&gt; 何でも良い</p></li></ul></div><p>交差行列パターンを使って、特定の空間関係の評価がより簡潔な方法で可能です。交差行列パターンのテストに<a class="xref" href="ST_Relate.html" title="ST_Relate">ST_Relate</a>と<a class="xref" href="ST_RelateMatch.html" title="ST_RelateMatch">ST_RelateMatch</a>を使うことができます。上に挙げた一つ目の例では、二つのラインがライン内部でインタセクトする交差行列パターンは'<span class="bold"><strong>1*1***1**</strong></span>'となります。</p><pre class="programlisting">-- ライン内でインタセクトする道路区間を見つける
SELECT a.id
FROM roads a, roads b
WHERE a.id != b.id
      AND a.geom &amp;&amp; b.geom
      AND ST_Relate(a.geom, b.geom, '1*1***1**');</pre><p>二つ目の例です。一本のラインが部分的にポリゴン内部とポリゴン外部とにある場合の交差行列パターンは '<span class="bold"><strong>102101FF2</strong></span>'となります。</p><pre class="programlisting">-- 一部が湖の水涯線上にある波止場を見つける
SELECT a.lake_id, b.wharf_id
FROM lakes a, wharfs b
WHERE a.geom &amp;&amp; b.geom
      AND ST_Relate(a.geom, b.geom, '102101FF2');</pre></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="using-query-indexes"></a>5.2. 空間インデックスを使う</h2></div></div></div><p>空間条件を使用するクエリを構築する時、最良の効果を得るには、空間インデックスが存在する場合に (<a class="xref" href="using_postgis_dbmanagement.html#build-indexes" title="4.9. 空間インデックス">Section 4.9, “空間インデックス”</a>参照)これを確実に使用することが重要です。そのためには、<code class="code">WHERE</code>節や<code class="code">ON</code>節で、空間演算子またはインデックス対応関数を使用しなければなりません。 </p><p>空間演算子には、バウンディングボックス演算子 (最もよく使われるのは<a class="xref" href="geometry_overlaps.html" title="&amp;&amp;">&amp;&amp;</a>です。<a class="xref" href="reference.html#operators-bbox" title="8.10.1. バウンディングボックス演算子">Section 8.10.1, “バウンディングボックス演算子”</a>参照)、および近傍クエリで使用される距離演算子 (最もよく使われるのは<a class="xref" href="geometry_distance_knn.html" title="&lt;-&gt;">&lt;-&gt;</a>です。<a class="xref" href="reference.html#operators-distance" title="8.10.2. 距離演算子">Section 8.10.2, “距離演算子”</a>参照)が含まれます。 </p><p>インデックス対応関数は、自動的にバウンディングボックス演算子を空間条件に追加します。インデックス対応関数は空間関係述語を含みます。空間関係述語には、<a class="xref" href="ST_Contains.html" title="ST_Contains">ST_Contains</a>, <a class="xref" href="ST_ContainsProperly.html" title="ST_ContainsProperly">ST_ContainsProperly</a>, <a class="xref" href="ST_CoveredBy.html" title="ST_CoveredBy">ST_CoveredBy</a>, <a class="xref" href="ST_Covers.html" title="ST_Covers">ST_Covers</a>, <a class="xref" href="ST_Crosses.html" title="ST_Crosses">ST_Crosses</a>, <a class="xref" href="ST_Intersects.html" title="ST_Intersects">ST_Intersects</a>, <a class="xref" href="ST_Overlaps.html" title="ST_Overlaps">ST_Overlaps</a>, <a class="xref" href="ST_Touches.html" title="ST_Touches">ST_Touches</a>, <a class="xref" href="ST_Within.html" title="ST_Within">ST_Within</a>, <a class="xref" href="ST_Within.html" title="ST_Within">ST_Within</a>, <a class="xref" href="ST_3DIntersects.html" title="ST_3DIntersects">ST_3DIntersects</a>があり、距離述語には<a class="xref" href="ST_DWithin.html" title="ST_DWithin">ST_DWithin</a>, <a class="xref" href="ST_DFullyWithin.html" title="ST_DFullyWithin">ST_DFullyWithin</a>, <a class="xref" href="ST_3DDFullyWithin.html" title="ST_3DDFullyWithin">ST_3DDFullyWithin</a>, <a class="xref" href="ST_3DDWithin.html" title="ST_3DDWithin">ST_3DDWithin</a> があります。 </p><p><a class="xref" href="ST_Distance.html" title="ST_Distance">ST_Distance</a>といった関数は、演算の最適化のためにはインデックスを<span class="emphasis"><em>使用しません</em></span>。例えば、次のクエリは、大きなテーブルでは非常に遅くなります。</p><pre class="programlisting">SELECT geom
FROM geom_table
WHERE ST_Distance( geom, 'SRID=312;POINT(100000 200000)' ) &lt; 100</pre><p>このクエリは<code class="code">geom_table</code>テーブル内の、(100000, 200000)のポイントから100単位内にある全てのジオメトリを選択します。テーブル内の個々のポイントと指定したポイントとの距離を計算しているため、非常に遅くなります。すなわち、1回の<code class="varname">ST_Distance()</code>の計算で、テーブルの<span class="bold"><strong>全ての</strong></span>行について計算することになります。 </p><p>インデックス対応関数<a class="xref" href="ST_DWithin.html" title="ST_DWithin">ST_DWithin</a>を使用すると、処理行数を実質的に減らすことができます。次のようにします。</p><pre class="programlisting">SELECT geom
FROM geom_table
WHERE ST_DWithin( geom, 'SRID=312;POINT(100000 200000)', 100 )
</pre><p>このクエリは、同じジオメトリを選択しますが、より効率的な方法を取ります。 <code class="varname">ST_DWithin()</code>が内部で<code class="varname">&amp;&amp;</code>演算子をクエリジオメトリのバウンディングボックスを拡大したボックスで使うことによって可能となります。<code class="code">geom</code>上に空間インデックスが存在するなら、クエリプランナは距離計算の前に対象行数を減らすためにインデックスを使えることを認識します。空間インデックスによって、バウンディングボックスが拡張された範囲とオーバラップするジオメトリだけを検索して、そのため、求めようとする距離内にある<span class="emphasis"><em>かも知れない</em></span>ジオメトリを検索することができます。その後で、結果集合内のレコードを含めるかどうかを確認するための実際の距離計算が行われます。 </p><p>詳細情報と例については<a class="ulink" href="https://postgis.net/workshops/postgis-intro/indexing.html" target="_top">PostGIS Workshop</a>をご覧下さい。 </p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="examples_spatial_sql"></a>5.3. 空間SQLの例</h2></div></div></div><p>本節の例では、線の道路のテーブルとポリゴンの市区町村境界テーブルとを使います。<code class="varname">bc_roads</code>テーブルの定義は次の通りです。</p><pre class="programlisting">Column    | Type              | Description
----------+-------------------+-------------------
gid       | integer           | Unique ID
name      | character varying | Road Name
geom      | geometry          | Location Geometry (Linestring)</pre><p><code class="varname">bc_municipality</code>テーブルの定義は次の通りです。</p><pre class="programlisting">Column   | Type              | Description
---------+-------------------+-------------------
gid      | integer           | Unique ID
code     | integer           | Unique ID
name     | character varying | City / Town Name
geom     | geometry          | Location Geometry (Polygon)</pre><div class="qandaset"><a name="idp54235856"></a><dl><dt>5.3.1. <a href="using_postgis_query.html#qa_total_length_roads">道路の総延長はkm表記でいくらになるでしょう?</a></dt><dt>5.3.2. <a href="using_postgis_query.html#idp54238672">プリンスジョージ市の大きさはha表記でいくらになるでしょう?</a></dt><dt>5.3.3. <a href="using_postgis_query.html#idp54241104">県内で最も大きな面積となる自治体はどこでしょう?</a></dt><dt>5.3.4. <a href="using_postgis_query.html#idp54243920">各自治体内に含まれる道路の総延長はいくらでしょう?</a></dt><dt>5.3.5. <a href="using_postgis_query.html#idp54246736">プリンスジョージ市内の全ての道路からなるテーブルを作ります。</a></dt><dt>5.3.6. <a href="using_postgis_query.html#idp54249168">ビクトリア州の「ダグラス通り」の長さはkm表記でいくらになるでしょう?</a></dt><dt>5.3.7. <a href="using_postgis_query.html#idp54275792">穴を持つ自治体ポリゴンのうち最も大きいのはどれでしょう?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%"><col></colgroup><tbody><tr class="question"><td align="left" valign="top"><a name="qa_total_length_roads"></a><a name="idp54236496"></a><p><b>5.3.1.</b></p></td><td align="left" valign="top"><p>道路の総延長はkm表記でいくらになるでしょう?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>この問題は、次のようなとても単純なSQLで答えを得ることができます。</p><pre class="programlisting">SELECT sum(ST_Length(geom))/1000 AS km_roads FROM bc_roads;

km_roads
------------------
70842.1243039643
</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp54238672"></a><a name="idp54238928"></a><p><b>5.3.2.</b></p></td><td align="left" valign="top"><p>プリンスジョージ市の大きさはha表記でいくらになるでしょう?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>このクエリでは、属性条件 (municipality name, 自治体名)に (ポリゴン面積の)空間計算を併用しています。</p><pre class="programlisting">SELECT
  ST_Area(geom)/10000 AS hectares
FROM bc_municipality
WHERE name = 'PRINCE GEORGE';

hectares
------------------
32657.9103824927
</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp54241104"></a><a name="idp54241360"></a><p><b>5.3.3.</b></p></td><td align="left" valign="top"><p>県内で最も大きな面積となる自治体はどこでしょう?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>このクエリでは、順序付けの値に空間計測関数を使っています。この問題に対しては複数の方法がありますが、最も効果的な方法は次の通りです。</p><pre class="programlisting">SELECT
  name,
  ST_Area(geom)/10000 AS hectares
FROM bc_municipality
ORDER BY hectares DESC
LIMIT 1;

name           | hectares
---------------+-----------------
TUMBLER RIDGE  | 155020.02556131
</pre><p>このクエリの答えを出すためには、全てのポリゴンの面積を求める必要があることに注意して下さい。このクエリを多く実行する場合、性能向上のためにテーブルにareaカラムを追加して、別のインデックスを追加することができるようにするのは、意義のあることです。結果を距離について降順に並べ替え、PostgreSQLの"LIMIT"コマンドを用いることで、max()のような集約関数を使わずに、簡単に最も大きい値を集約関数を得ることができます。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="idp54243920"></a><a name="idp54244176"></a><p><b>5.3.4.</b></p></td><td align="left" valign="top"><p>各自治体内に含まれる道路の総延長はいくらでしょう?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>これは、二つのテーブルからデータを持ち込んで (結合して)いるので「空間結合」の例です。しかし、結合の条件として共通キーの上で接続するという普通のリレーションのやり方でなく空間インタラクション条件 (「含む」)を使っています。</p><pre class="programlisting">SELECT
  m.name,
  sum(ST_Length(r.geom))/1000 as roads_km
FROM bc_roads AS r
JOIN bc_municipality AS m
  ON ST_Contains(m.geom, r.geom)
GROUP BY m.name
ORDER BY roads_km;

name                        | roads_km
----------------------------+------------------
SURREY                      | 1539.47553551242
VANCOUVER                   | 1450.33093486576
LANGLEY DISTRICT            | 833.793392535662
BURNABY                     | 773.769091404338
PRINCE GEORGE               | 694.37554369147
...</pre><p>このクエリは、テーブル内の全ての道路の合計を最終結果 (この例での話ですが約250Kmの道です)にまとめられるので、少し時間がかかります。より小さいオーバレイ (数百の道路で数千のレコード)の場合、応答はもっと早くなりえます。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="idp54246736"></a><a name="idp54246992"></a><p><b>5.3.5.</b></p></td><td align="left" valign="top"><p>プリンスジョージ市内の全ての道路からなるテーブルを作ります。</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>これは「オーバレイ」の例です。つまり、二つのテーブルを取得して、空間的に切り取られた結果からなる新しいテーブルを出力します。上で示した「空間結合」と違い、このクエリは実際に新しいジオメトリを生成します。生成されたオーバレイはターボのかかった空間結合みたいなもので、より確かな解析作業に便利です。</p><pre class="programlisting">CREATE TABLE pg_roads as
SELECT
  ST_Intersection(r.geom, m.geom) AS intersection_geom,
  ST_Length(r.geom) AS rd_orig_length,
  r.*
FROM bc_roads AS r
JOIN bc_municipality AS m
  ON ST_Intersects(r.geom, m.geom)
WHERE
  m.name = 'PRINCE GEORGE';
</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp54249168"></a><a name="idp54249424"></a><p><b>5.3.6.</b></p></td><td align="left" valign="top"><p>ビクトリア州の「ダグラス通り」の長さはkm表記でいくらになるでしょう?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><pre class="programlisting">SELECT
  sum(ST_Length(r.geom))/1000 AS kilometers
FROM bc_roads r
JOIN bc_municipality m
  ON ST_Intersects(m.geom, r.geom
WHERE
  r.name = 'Douglas St'
  AND m.name = 'VICTORIA';

kilometers
------------------
4.89151904172838
</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp54275792"></a><a name="idp54276048"></a><p><b>5.3.7.</b></p></td><td align="left" valign="top"><p>穴を持つ自治体ポリゴンのうち最も大きいのはどれでしょう?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><pre class="programlisting">SELECT gid, name, ST_Area(geom) AS area
FROM bc_municipality
WHERE ST_NRings(geom) &gt; 1
ORDER BY area DESC LIMIT 1;

gid  | name         | area
-----+--------------+------------------
12   | SPALLUMCHEEN | 257374619.430216
</pre></td></tr></tbody></table></div></div></div><div class="navfooter"><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="using_postgis_dbmanagement.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="performance_tips.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 4. データ管理 </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 6. 性能向上に関する技法</td></tr></table></div></body></html>
