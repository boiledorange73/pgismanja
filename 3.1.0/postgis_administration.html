<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>第3章 PostGIS管理</title><link rel="stylesheet" type="text/css" href="docbook.css"><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="PostGIS 3.1.0 マニュアル"><link rel="up" href="index.html" title="PostGIS 3.1.0 マニュアル"><link rel="prev" href="postgis_installation.html" title="第2章 PostGISインストール"><link rel="next" href="postgis_usage.html" title="第4章 PostGISの使用"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第3章 PostGIS管理</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="postgis_installation.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="postgis_usage.html">次へ</a></td></tr></table></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="postgis_administration"></a>第3章 PostGIS管理</h1></div></div></div><div class="toc"><div class="toc-title">目次</div><dl class="toc"><dt><span class="sect1"><a href="postgis_administration.html#database_tuning_configuration">3.1. パフォーマンスチューニング</a></span></dt><dd><dl><dt><span class="sect2"><a href="postgis_administration.html#idp52413944">3.1.1. 起動時</a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#idp52440184">3.1.2. 実行時</a></span></dt></dl></dd><dt><span class="sect1"><a href="postgis_administration.html#raster_configuration">3.2. ラスタ機能の設定</a></span></dt><dt><span class="sect1"><a href="postgis_administration.html#create_spatial_db">3.3. 空間テーブルの作成</a></span></dt><dd><dl><dt><span class="sect2"><a href="postgis_administration.html#create_new_db_extensions">3.3.1. エクステンションを使って空間データベースを有効にする</a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#create_new_db">3.3.2. エクステンションを使わずに空間データベースを有効にする (非推奨)</a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#templatepostgis">3.3.3. 空間データベースをテンプレートから生成する</a></span></dt></dl></dd><dt><span class="sect1"><a href="postgis_administration.html#upgrading">3.4. 空間データベースのアップグレード</a></span></dt><dd><dl><dt><span class="sect2"><a href="postgis_administration.html#soft_upgrade">3.4.1. ソフトアップグレード </a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#hard_upgrade">3.4.2. ハードアップグレード</a></span></dt></dl></dd></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="database_tuning_configuration"></a>3.1. パフォーマンスチューニング</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="postgis_administration.html#idp52413944">3.1.1. 起動時</a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#idp52440184">3.1.2. 実行時</a></span></dt></dl></div><p>PostGISの調整はPostgreSQLの作業量の調整と非常に似ています。ジオメトリとラスタは重く、メモリ関連の最適化は他のPostgreSQLクエリと比べて影響が大きい点だけは留意して下さい。</p><p>PostgreSQLの最適化に関する一般的な詳細は、<a class="ulink" href="https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server" target="_top">Tuning your PostgreSQL Server</a>をご覧ください。</p><p>PostgreSQL 9.4以上では、<code class="code">ALTER SYSTEM</code>を使うことで、<code class="code">postgresql.conf</code>や<code class="code">postgresql.auto.conf</code>を触ることなくサーバレベルで設定できます。</p><pre class="programlisting">ALTER SYSTEM SET work_mem = '256MB';
-- 起動時設定でない設定を強制します。新規接続に影響を与えます。
SELECT pg_reload_conf();
-- 現在の設定値を表示
-- 全ての設定を見るにはSHOW ALLを使います
SHOW work_mem;</pre><p>PostgreSQLの設定に加えて、PostGISには<a class="xref" href="reference.html#PostGIS_GUC" title="5.23. Grand Unified Custom変数 (GUC)">「Grand Unified Custom変数 (GUC)」</a>で挙げる独自設定があります。</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp52413944"></a>3.1.1. 起動時</h3></div></div></div><p>次に示す設定は<code class="code">postgresql.conf</code>にあります。 </p><p>
         <a class="ulink" href="http://www.postgresql.org/docs/current/static/runtime-config-query.html#GUC-CONSTRAINT-EXCLUSION" target="_top">constraint_exclusion</a>
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>デフォルト: partition </p></li><li class="listitem"><p>一般的にテーブルのパーティショニングに使われます。デフォルトとして"partition"に設定されています。継承階層内にあり、プランナにペナルティ以外を払わないなら、クエリプランナにテーブルの制約条件の解析だけを行わせるので、PostgreSQL 8.4以上ではこれが理想的です。 </p></li></ul></div><p>
         <a class="ulink" href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-SHARED-BUFFERS" target="_top">shared_buffers</a>
      </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>デフォルト: PostgreSQL 9.6では128MB以下 </p></li><li class="listitem"><p>利用可能なRAMの25%から40%を設定します。Windowsでは高く設定することができないかも知れません。 </p></li></ul></div><p><a class="ulink" href="https://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-MAX-WORKER-PROCESSES" target="_top">max_worker_processes</a> これは、PostgreSQL 9.4以上で有効です。PostgreSQL 9.6以上では、パラレルクエリ処理に使うプロセス数の最大値の制御で、さらに重要なものとなっています。 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>デフォルト: 8 </p></li><li class="listitem"><p>システムが対応できるバックグラウンドプロセスの最大値を設定します。このパラメータはサーバ起動時のみ設定できます。 </p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp52440184"></a>3.1.2. 実行時</h3></div></div></div><p><a class="ulink" href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-WORK-MEM" target="_top">work_mem</a> - 並べ替えや複雑なクエリに使われるメモリのサイズの設定 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>デフォルト: 1-4MB </p></li><li class="listitem"><p>大きなデータベースの場合や、複雑なクエリの場合、RAMが多い場合は値を大きくするように調整します。 </p></li><li class="listitem"><p>同時接続ユーザ数が多い場合や、RAMが少ない場合には値を小さくするように調整します。 </p></li><li class="listitem"><p>たくさんのRAMを持ち、少数の開発者しかいない場合は次のようにします。 </p><pre class="programlisting">SET work_mem TO '256MB';</pre><p>
          </p></li></ul></div><p><a class="ulink" href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-MAINTENANCE-WORK-MEM" target="_top">maintenance_work_mem</a> - VACUUM, CREATE INDEX等で使われるメモリのサイズ </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>デフォルト: 16-64MB </p></li><li class="listitem"><p>一般的には低すぎます - メモリスワップの間、入出力が拘束され、オブジェクトがロックされます。 </p></li><li class="listitem"><p>たくさんのRAMを持つ本番サーバでは32MBから1GBが推奨ですが、同時接続ユーザ数に依存します。たくさんのRAMを持ち、少数の開発者しかいない場合は次のようにします。 </p><pre class="programlisting">SET maintenance_work_mem TO '1GB';</pre><p>
          </p></li></ul></div><p>
        <a class="ulink" href="https://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-MAX-PARALLEL-WORKERS-PER-GATHER" target="_top">max_parallel_workers_per_gather</a>
      </p><p>この設定はPostgreSQL 9.6以上で使用でき、並列クエリに対応しているPostGIS 2.3以上に影響は限られます。0より大きい値に設定すると、<code class="code">ST_Intersects</code>といった関係関数を含むクエリで、複数プロセッサが使われるようにできます。その時、2倍を超える速度が出る可能性があります。予備のプロセッサが多数ある場合には、この値をプロセッサ数に変更するべきです。また、<code class="code">max_worker_processes</code>をこの値と同じにするようにします。 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>デフォルト: 0 </p></li><li class="listitem"><p>単一の<code class="varname">Gather</code>ノードが開始できるワーカの最大数を設定します。並列ワーカは、<code class="varname">max_worker_processes</code>で確立されたプロセスのプールから取得されます。要求したワーカ数は、実際には実行可能になっていない場合があることに注意して下さい。これが発生する場合には、想定より少ないワーカでプランが実行され、非効率になります。これの値を0 (デフォルト値)にすると、パラレルクエリ実行が無効になります。 </p></li></ul></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="raster_configuration"></a>3.2. ラスタ機能の設定</h2></div></div></div><p>ラスタ機能を有効にしたら、下に示す確実な設定方法を読んだ方がいいです。 </p><p>PostGIS 2.1.3以降では、データベース外ラスタと全てのラスタドライバは、デフォルトでは無効になっています。これらを有効にするには、サーバ上で、環境変数<code class="varname">POSTGIS_GDAL_ENABLED_DRIVERS</code>と<code class="varname">POSTGIS_ENABLE_OUTDB_RASTERS</code>を設定します。PostGIS 2.2では、<a class="xref" href="reference.html#PostGIS_GUC" title="5.23. Grand Unified Custom変数 (GUC)">「Grand Unified Custom変数 (GUC)」</a>に従って設定する、クロスプラットフォームな手法があります。</p><p>データベース外ラスタを有効にするには次のようにします。</p><pre class="programlisting">POSTGIS_ENABLE_OUTDB_RASTERS=1</pre><p>他の値を入れたり、値を入れない場合には、データベース外ラスタは無効になります。</p><p>インストールしたGDALのドライバを有効にするには、次の環境変数を設定します。</p><pre class="programlisting">POSTGIS_GDAL_ENABLED_DRIVERS=ENABLE_ALL</pre><p>一部のドライバのみ有効にしたい場合には、環境変数を次のように設定します。</p><pre class="programlisting">POSTGIS_GDAL_ENABLED_DRIVERS="GTiff PNG JPEG GIF XYZ"</pre><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Windows上の場合は、ドライバリストに引用符をつけないで下さい。</p></td></tr></table></div><p>環境変数の設定はOSによって異なります。UbuntuまたはDebian上でapt-postgresqlを経由したPostgreSQLのインストールについては、<code class="filename">/etc/postgresql/<em class="replaceable"><code>10</code></em>/<em class="replaceable"><code>main</code></em>/environment</code>を編集するのが好ましい方法です。 ここで、10はPostgreSQLのバージョンを指し、mainはクラスタを指します。</p><p>Windowsでサービスとして実行している場合には、システム変数で設定します。Windows 7では、コンピュータを右クリックしてプロパティをクリックするか、エクスプローラの検索バーに<code class="varname">コントロール パネル\すべてのコントロール パネル項目\システム</code>を指定します。<span class="emphasis"><em>システムの詳細設定 -&gt; 詳細設定 -&gt; 環境変数</em></span>を順にクリックして、新しいシステム環境変数を追加します。</p><p>環境変数を設定した後は、設定を反映させるために、PostgreSQLサービスの再起動が必要です。</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="create_spatial_db"></a>3.3. 空間テーブルの作成</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="postgis_administration.html#create_new_db_extensions">3.3.1. エクステンションを使って空間データベースを有効にする</a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#create_new_db">3.3.2. エクステンションを使わずに空間データベースを有効にする (非推奨)</a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#templatepostgis">3.3.3. 空間データベースをテンプレートから生成する</a></span></dt></dl></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="create_new_db_extensions"></a>3.3.1. エクステンションを使って空間データベースを有効にする</h3></div></div></div><p>PostgreSQL 9.1以上を使っていて、エクステンションのPostGISモジュールをコンパイル、インストールしている場合には、エクステンションというメカニズムを使用して、データベースを空間データベースに切り替えることができます。 </p><p>中核となるPostGISエクステンションには、ジオメトリ、ジオグラフィ、spatial_ref_sysおよび全ての関数とコメントが含まれています。ラスタとトポロジは別のエクステンションになっています。 </p><p>空間データベースにしたいデータベース上で次のSQLを実行します。 </p><pre class="programlisting">CREATE EXTENSION IF NOT EXISTS plpgsql;
      CREATE EXTENSION postgis;
      CREATE EXTENSION postgis_raster; -- OPTIONAL
      CREATE EXTENSION postgis_topology; -- OPTIONAL
</pre><p>
	</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="create_new_db"></a>3.3.2. エクステンションを使わずに空間データベースを有効にする (非推奨)</h3></div></div></div><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>これは、通常はPostgreSQLのエクステンションのディレクトリ内にPostGISをインストールできないか、したくない場合 (たとえばテスト中や開発中、または制限のある環境内)にのみ必要となります。</p></td></tr></table></div><p>ビルドの際に指定した<code class="filename">[prefix]/share/contrib</code>内にある様々なSQLファイルをロードしてPostGISオブジェクトと関数の定義をデータベースに追加します。 </p><p>中核のPostGISオブジェクト (ジオメトリ型とジオグラフィ型、これらに対応する関数)は<code class="filename">postgis.sql</code>スクリプトにあります。ラスタオブジェクトは<code class="filename">rtpostgis.sql</code>スクリプトにあります。トポロジオブジェクトは<code class="filename">topology.sql</code>スクリプトにあります。 </p><p>完全なEPSG座標系定義IDセットについては、<code class="filename">spatial_ref_sys.sql</code>定義ファイルをロードして<code class="varname">spatial_ref_sys</code>テーブルを生成して下さい。これによりジオメトリ関数ST_Transform()が実行できるようになります。 </p><p>PostGIS関数にコメントを追加したい場合には、<code class="filename">postgis_comments.sql</code>スクリプト内のコメントが見つかると思います。コメントは<span class="command"><strong>psql</strong></span>のターミナルウィンドウから単に<span class="command"><strong>\dd [関数名]</strong></span>と打ち込むだけで見ることができます。 </p><p>ターミナルで次のシェルコマンドを実行します。 </p><pre class="programlisting">DB=[データベース名]
    SCRIPTSDIR=`pg_config --sharedir`/contrib/postgis-3.1/

    # Core objects
    psql -d ${DB} -f ${SCRIPTSDIR}/postgis.sql
    psql -d ${DB} -f ${SCRIPTSDIR}/spatial_ref_sys.sql
    psql -d ${DB} -f ${SCRIPTSDIR}/postgis_comments.sql # OPTIONAL

    # Raster support (OPTIONAL)
    psql -d ${DB} -f ${SCRIPTSDIR}/rtpostgis.sql
    psql -d ${DB} -f ${SCRIPTSDIR}/raster_comments.sql # OPTIONAL

    # Topology support (OPTIONAL)
    psql -d ${DB} -f ${SCRIPTSDIR}/topology.sql
    psql -d ${DB} -f ${SCRIPTSDIR}/topology_comments.sql # OPTIONAL
</pre><p>
  </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="templatepostgis"></a>3.3.3. 空間データベースをテンプレートから生成する</h3></div></div></div><p>PostGISのディストリビューション (特にPostGIS &gt;= 1.1.5のWin32インストーラ)の中には、<code class="varname">template_postgis</code>というテンプレートにPostGIS関数をロードしていることがあります。PostgreSQLに<code class="varname">template_postgis</code>データベースが存在するなら、ユーザやアプリケーションは、空間データベースの生成をコマンドひとつで済ませられます。この2種類のやり方のどちらを使うににしても、データベースユーザは、新しいデータベースを作成する権限を与えられている必要があります。 </p><p>シェルからの実行は次の通りです。 </p><pre class="programlisting"># createdb -T template_postgis my_spatial_db</pre><p>SQLからの実行は次の通りです。 </p><pre class="programlisting">postgres=# CREATE DATABASE my_spatial_db TEMPLATE=template_postgis</pre></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="upgrading"></a>3.4. 空間データベースのアップグレード</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="postgis_administration.html#soft_upgrade">3.4.1. ソフトアップグレード </a></span></dt><dt><span class="sect2"><a href="postgis_administration.html#hard_upgrade">3.4.2. ハードアップグレード</a></span></dt></dl></div><p>既存の空間データベースのアップグレードは、新しいPostGISオブジェクト定義の置き換えや導入を必要とするとき、慎重を要することがあります。 </p><p>不幸なことに、定義の全てが実行中のデータベース内で簡単には置き換えられるわけではないので、ダンプ/リロードが最善策となることがあります。 </p><p>PostGISには、マイナーバージョンアップやバグフィクスリリースの場合に使うソフトアップグレードと、メジャーアップグレードで使うハードアップグレードが用意されています。 </p><p>PostGISをアップグレードしようとする前にデータのバックアップを取ることは、常に価値のあるものです。pg_dumpで -Fc フラグを使うと、ハードアップグレードによってダンプを常にリストアすることができます。 </p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="soft_upgrade"></a>3.4.1. ソフトアップグレード </h3></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect3"><a href="postgis_administration.html#soft_upgrade_sql_script">3.4.1.1. 9.1より前またはエクステンションを使わないソフトアップグレード</a></span></dt><dt><span class="sect3"><a href="postgis_administration.html#soft_upgrade_extensions">3.4.1.2. 9.1以上でエクステンションを使ったソフトアップグレード</a></span></dt></dl></div><p>エクステンションを使ってインストールした場合は、エクステンションモデルでアップグレードしなければなりません。 古いSQLスクリプトを使ってインストールした場合は、SQLスクリプトでアップグレードすべきです。適切な方を参照して下さい。</p><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="soft_upgrade_sql_script"></a>3.4.1.1. 9.1より前またはエクステンションを使わないソフトアップグレード</h4></div></div></div><p>PostGISをエクステンションを使わずにインストールした人向けです。エクステンションを使っていてこの方法を使うと、次のようなメッセージが現れます。</p><pre class="programlisting">can't drop ... because postgis extension depends on it</pre><p>ご注意: PostGIS 1.*またはr7429以前のPostGIS 2.*へ移行する場合には、この手続きを使うことができませんが、<a class="link" href="postgis_administration.html#hard_upgrade" title="3.4.2. ハードアップグレード">HARD UPGRADE</a>を実行する必要があります。 </p><p>コンパイルとインストール (make install)の実行後に、インストール先フォルダ内にある<code class="filename">*_upgrade.sql</code>のファイルの集合を見つけておくべきです。次のコマンドで一覧を得られます。 </p><pre class="programlisting">ls `pg_config --sharedir`/contrib/postgis-3.1.0/*_upgrade.sql</pre><p><code class="filename">postgis_upgrade.sql</code>から順番に全てをロードします。 </p><pre class="programlisting">psql -f postgis_upgrade.sql -d [データベース名]</pre><p>同じ手続きをラスタ、トポロジ、SFCGALエクステンションに適用します。それぞれのファイル名は<code class="filename">rtpostgis_upgrade.sql</code>, <code class="filename">topology_upgrade.sql</code>, <code class="filename">sfcgal_upgrade.sql</code>になります。次のように実行します。 </p><pre class="programlisting">psql -f rtpostgis_upgrade.sql -d [データベース名]</pre><pre class="programlisting">psql -f topology_upgrade.sql -d [データベース名]</pre><pre class="programlisting">psql -f sfcgal_upgrade.sql -d [データベース名]</pre><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>求める版へのアップグレードに使う特定の<code class="filename">postgis_upgrade.sql</code>が発見できない場合には、ソフトアップグレードを実行するにはあまりに前の版を使っています。<a class="link" href="postgis_administration.html#hard_upgrade" title="3.4.2. ハードアップグレード">ハードアップグレード</a>が必要です。 </p></td></tr></table></div><p><a class="xref" href="PostGIS_Full_Version.html" title="PostGIS_Full_Version">PostGIS_Full_Version</a>関数の"procs need upgrade"というメッセージで、この種のアップグレードを実行する必要性についての情報が得られます。 </p></div><div class="sect3"><div class="titlepage"><div><div><h4 class="title"><a name="soft_upgrade_extensions"></a>3.4.1.2. 9.1以上でエクステンションを使ったソフトアップグレード</h4></div></div></div><p>エクステンションを使ってPostGISをインストールした場合には、エクステンションを使ってアップグレードする必要があります。エクステンションを使ったマイナーアップグレードはかなり楽です。</p><pre class="programlisting">ALTER EXTENSION postgis UPDATE TO "3.1.0";
ALTER EXTENSION postgis_topology UPDATE TO "3.1.0";</pre><p>次のようなエラー通知が表示されることがあります。</p><pre class="programlisting">No migration path defined for ... to 3.1.0</pre><p>この場合は、データベースをバックアップして、<a class="xref" href="postgis_administration.html#create_new_db_extensions" title="3.3.1. エクステンションを使って空間データベースを有効にする">「エクステンションを使って空間データベースを有効にする」</a>に記述されているように新しいデータベースを生成し、バックアップを新しいデータベースにリストアしなければなりません。</p><p>次のようなメッセージを得ることがあります。</p><pre class="programlisting">Version "3.1.0" of extension "postgis" is already installed</pre><p>この場合は、全てアップデートされていて、安全に無視できます。SVN版から次版 (新しい版番号を得ていないもの)にアップグレード<span class="bold"><strong>しようとしない限り</strong></span>、"next"を版文字列に追加できます。ただし、次回に"next"を削除する必要があります。 </p><pre class="programlisting">ALTER EXTENSION postgis UPDATE TO "3.1.0next";
ALTER EXTENSION postgis_topology UPDATE TO "3.1.0next";</pre><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>PostGISをバージョン指定なしにインストールした場合には、 しばしばリストアの前のPostGIS EXTENSIONの再インストールをとばすことができます。 バックアップは<code class="code">CREATE EXTENSION postgis</code>だけで、リストアの間に最新版になります。</p></td></tr></table></div><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>PostGISエクステンションを3.0.0以前からアップグレードする場合には、PostGISラスタ機能はパッケージ化されずに終わります。ラスタ機能の再パッケージは次のコマンドでできます。</p><pre class="programlisting">
    CREATE EXTENSION postgis_raster FROM unpackaged;
    </pre><p> その後、不要なら削除します。次のようにします。 </p><pre class="programlisting">DROP EXTENSION postgis_raster;
    </pre><p>
    </p></td></tr></table></div></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="hard_upgrade"></a>3.4.2. ハードアップグレード</h3></div></div></div><p>ハードアップグレードとは、PostGISで利用可能なデータの完全なダンプ/リロードを意味します。PostGISオブジェクトの内部格納状態が変更される場合や、ソフトアップグレードができない場合に、ハードアップグレードが必要です。付録の<a class="link" href="release_notes.html" title="付録A 付録">リリースノート</a>に、版ごとについて、ダンプ/リロード (ハードアップグレード)の要否を記載しています。 </p><p>ダンプ/リロード作業はpostgis_restore.plスクリプトが補助します。このスクリプトは、PostGIS (古いものを含む)に属する定義を全て飛ばすように注意します。また、重複シンボルエラーや非推奨オブジェクトを持越すことなく、スキーマとデータをPostGISをインストールしたデータベースにリストアできます 。 </p><p>Windows用に関する追加情報は<a class="ulink" href="http://trac.osgeo.org/postgis/wiki/UsersWikiWinUpgrade" target="_top">Windows Hard upgrade</a>にあります。</p><p>手続きは次の通りです。  </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>アップグレードしたデータベース (<code class="varname">olddb</code>と呼ぶことにしましょう)の「カスタム書式」のダンプを、バイナリBLOBデータを含めたダンプを指定して (-b)、verboseモード (-v)で生成します。ユーザはデータベースのオーナーになることができ、PostgreSQLのスーパーユーザである必要はありません。 </p><pre class="programlisting">pg_dump -h localhost -p 5432 -U postgres -Fc -b -v -f "/somepath/olddb.backup" olddb</pre></li><li class="listitem"><p>新しいデータベースにPostGISを、PostGISが無い状態からインストールします。このデータベースを<code class="varname">newdb</code>と呼ぶことにします。この作業に関する説明については<a class="xref" href="postgis_administration.html#create_new_db" title="3.3.2. エクステンションを使わずに空間データベースを有効にする (非推奨)">「エクステンションを使わずに空間データベースを有効にする (非推奨)」</a>と<a class="xref" href="postgis_administration.html#create_new_db_extensions" title="3.3.1. エクステンションを使って空間データベースを有効にする">「エクステンションを使って空間データベースを有効にする」</a>とを参照して下さい。 </p><p>ダンプにあるspatial_ref_sysは、リストアされますが、既にあるspatial_ref_sysを上書きしません。リストア対象のデータベースに公式データセットの訂正が確実に伝わるようにするためです。標準のエントリを上書きしたい場合は、newdbを生成する際にspaltial_ref_sys.sqlファイルをロードしないだけです。 </p><p>データベースが本当に古く、ビューや関数に、長く非推奨になっている関数があるような場合には、関数やビューを使えるようにする<code class="filename">legacy.sql</code>をロードする必要があるでしょう。ただし、本当に必要な場合に限ります。可能なら、ビューや関数をダンプせずにアップグレードすることを検討して下さい。非推奨関数は、<code class="filename">uninstall_legacy.sql</code>で後から削除することができます。 </p></li><li class="listitem"><p>バックアップを新しい<code class="varname">newdb</code>データベースにリストアするには、postgis_restore.plを使います。psqlが予期せぬエラーを標準エラー出力に出すことがあります。これらのログを保存しておいて下さい。 </p><pre class="programlisting">perl utils/postgis_restore.pl "/somepath/olddb.backup" | psql -h localhost -p 5432 -U postgres newdb 2
&gt; errors.txt</pre></li></ol></div><p>エラーは次の場合に起こりえます。 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>ビューまたは関数の中に非推奨のPostGISオブジェクトを使っているものがある場合。これの訂正には、リストア前に<code class="filename">legacy.sql</code>スクリプトのロードを試してみることができます。非推奨オブジェクトをまだ持っている版のPostGISにリストアして、コードを作り替えた後に再び移動させることもできます。 <code class="filename">legacy.sql</code>を利用する場合は、非推奨関数を使うのをやめたコードに訂正して、<code class="filename">uninstall_legacy.sql</code>をロードするのを忘れないでください。 </p></li><li class="listitem"><p>ダンプファイル内のspatial_ref_sysにあるカスタムレコードが不正なSRIDになっていることがあります。妥当なSRID値は0より大きく999000より小さくなります。999000から999999の間は内部利用のための予約領域ですが、999999より大きい値は一切使用できません。全ての不正なSRIDを持つ独自レコードは、予約領域に移動しても保持されます。しかし、spatial_ref_sysテーブルから、値が保持されるように設定されているチェック制約が外れます。場合によっては (複数の不正なSRIDが同じ予約領域のSRID値に変換されるとき)、主キーも外れます。 </p><p>これを修正するために、独自のSRSを妥当な値 (910000..910999の範囲)のSRIDに複写し、全てのテーブルを新しいSRIDに変更 (<a class="xref" href="UpdateGeometrySRID.html" title="UpdateGeometrySRID">UpdateGeometrySRID</a>)し、spatial_ref_sysから不正なエントリを削除します。そして、次のようにチェック制約を再構築します。</p><pre class="programlisting">ALTER TABLE spatial_ref_sys ADD CONSTRAINT spatial_ref_sys_srid_check check (srid &gt; 0 AND srid &lt; 999000 );</pre><pre class="programlisting">ALTER TABLE spatial_ref_sys ADD PRIMARY KEY(srid));</pre><p>フランス<a class="ulink" href="https://en.wikipedia.org/wiki/Institut_g%C3%A9ographique_national" target="_top">IGN</a>地図を含む古いデータベースをアップグレードする場合には、おそらくSRIDが範囲外になり、データベースのインポート時に次のような問題に遭遇します。</p><pre class="programlisting"> WARNING: SRID 310642222 converted to 999175 (in reserved zone)</pre><p>この場合には、次のステップを試すことができます。最初にpostgis_restore.plから出たIGNをSQLから完全に破棄します。そのために次のコマンドを実行します。</p><pre class="programlisting">perl utils/postgis_restore.pl "/somepath/olddb.backup" 
&gt; olddb.sql</pre><p>さらに、次のコマンドを実行します。</p><pre class="programlisting">grep -v IGNF olddb.sql 
&gt; olddb-without-IGN.sql</pre><p>その後、新しいデータベースを生成し、必要なPostGISエクステンションを有効化して、<a class="ulink" href="https://raw.githubusercontent.com/Remi-C/IGN_spatial_ref_for_PostGIS/master/Put_IGN_SRS_into_Postgis.sql" target="_top">このスクリプト</a>で確実にフランスIGNの系を挿入します。これらの処理の後、次のようにデータのインポートを行います。 </p><pre class="programlisting">psql -h localhost -p 5432 -U postgres -d newdb -f olddb-without-IGN.sql  2
&gt; errors.txt</pre><p>

	</p></li></ol></div></div></div></div><div class="navfooter"><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="postgis_installation.html">戻る</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="postgis_usage.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">第2章 PostGISインストール </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 第4章 PostGISの使用</td></tr></table></div></body></html>
