<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>第9章 PostGIS よくある質問</title><link rel="stylesheet" type="text/css" href="docbook.css"><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="PostGIS 3.2.0 マニュアル"><link rel="up" href="index.html" title="PostGIS 3.2.0 マニュアル"><link rel="prev" href="UnlockRows.html" title="UnlockRows"><link rel="next" href="Topology.html" title="第10章 トポロジ"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第9章 PostGIS よくある質問</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="UnlockRows.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="Topology.html">次へ</a></td></tr></table></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="PostGIS_FAQ"></a>第9章 PostGIS よくある質問</h1></div></div></div><div class="qandaset"><a name="idp70651008"></a><dl><dt>9.1. <a href="PostGIS_FAQ.html#faq_where_tutorials">PostGISでの作業に関するチュートリアル、ガイド、ワークショップはどこにありますか?</a></dt><dt>9.2. <a href="PostGIS_FAQ.html#legacy_faq">PostGIS 1.5で動作していたアプリケーションやデスクトップツールがPostGIS 2.0では動作しなくなりました。解消するにはどうすればよいでしょうか?</a></dt><dt>9.3. <a href="PostGIS_FAQ.html#legacy_faq_gist">osm2pgsqlを使ってOpenStreetMapデータをロードするときに、failed: ERROR: operator class "gist_geometry_ops" does not exist for access method "gist"というエラーが発生しました。PostGIS 1.5では正しく動作していました。</a></dt><dt>9.4. <a href="PostGIS_FAQ.html#legacy_faq_read_view">PostgreSQL 9.0を使っていますが、OpenJump、Safe FME等のツールでジオメトリの読み取りや表示ができなくなってしまいましたが?</a></dt><dt>9.5. <a href="PostGIS_FAQ.html#pgadmin_shows_no_data_in_geom">pgAdminを使ってジオメトリカラムを表示しようとしたら空っぽでした。何か方法はありませんか?</a></dt><dt>9.6. <a href="PostGIS_FAQ.html#idp70717696">どの種類のジオメトリオブジェクトを格納できますか?</a></dt><dt>9.7. <a href="PostGIS_FAQ.html#idp70720384">たいへん混乱しました。ジオメトリとジオグラフィのどちらを使うべきでしょうか?</a></dt><dt>9.8. <a href="PostGIS_FAQ.html#idp70724608">もっとジオグラフィについて聞きたいです。 たとえば、ジオグラフィカラムにデータを入れて合理的な答えが得られる領域範囲はどれぐらいでしょうか、とか。極、全データが半球上になければならないのでしょうか(SQL Server 2008はそう)、速度等の制限はあるのでしょうか、とか。</a></dt><dt>9.9. <a href="PostGIS_FAQ.html#faq_how_to_define_geometry_table">GISオブジェクトをデータベースに挿入するにはどうしますか?</a></dt><dt>9.10. <a href="PostGIS_FAQ.html#idp70734848">空間クエリを作成するにはどうするのですか?</a></dt><dt>9.11. <a href="PostGIS_FAQ.html#idp70743040">大きなテーブルでの空間クエリの速度向上はどうするのですか?</a></dt><dt>9.12. <a href="PostGIS_FAQ.html#idp70753920">なぜPostgreSQLのR木インデクス機能を持たないのですか?</a></dt><dt>9.13. <a href="PostGIS_FAQ.html#idp70758144">なぜ AddGeometryColumn()関数と他のOpsnGIS関数を使うべきなのですか?</a></dt><dt>9.14. <a href="PostGIS_FAQ.html#idp70762112">半径内にあるオブジェクトを全て検索する最善の方法は何ですか?</a></dt><dt>9.15. <a href="PostGIS_FAQ.html#idp70765568">クエリの一部として投影変換を実現するにはどうしますか?</a></dt><dt>9.16. <a href="PostGIS_FAQ.html#idp70768000">ST_AsEWKTとST_AsTextとを、かなり大きいジオメトリで実行すると、空のフィールドが返りました。どうしたら良いですか?</a></dt><dt>9.17. <a href="PostGIS_FAQ.html#idp70770432">ST_Intersectsを使うと、二つのジオメトリがインタセクトしているのが分かっているのに、インタセクトしていないと言います。どうしたら良いですか?</a></dt><dt>9.18. <a href="PostGIS_FAQ.html#license_faq">PostGISを用いたソフトウェアをリリースしています。PostGISのようにGPLライセンスを使う必要があるのでしょうか?PostGISを使うとコードを全て公開しなければならないのでしょうか?</a></dt><dt>9.19. <a href="PostGIS_FAQ.html#overlay_inconsistent">オーバレイ操作と空間述語の結果が時々矛盾するのはなぜですか ?</a></dt></dl><table border="0" style="width: 100%;"><colgroup><col align="left" width="1%"><col></colgroup><tbody><tr class="question"><td align="left" valign="top"><a name="faq_where_tutorials"></a><a name="idp70651648"></a><p><b>9.1.</b></p></td><td align="left" valign="top"><p>PostGISでの作業に関するチュートリアル、ガイド、ワークショップはどこにありますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>手順ごとのチュートリアルガイドワークショップ<a class="ulink" href="http://postgis.net/workshops/postgis-intro/" target="_top">Introduction to PostGIS</a>があります。OpenGeo Suiteでの作業の入門編だけでなく梱包されたデータもあります。多分PostGISの最善のチュートリアルです。</p><p>BostonGISにも<a class="ulink" href="http://www.bostongis.com/PrinterFriendly.aspx?content_name=postgis_tut01" target="_top">PostGIS almost idiot's guide on getting started</a>があります。Windowsユーザに、より軸足を置いています。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="legacy_faq"></a><a name="idp70687872"></a><p><b>9.2.</b></p></td><td align="left" valign="top"><p>PostGIS 1.5で動作していたアプリケーションやデスクトップツールがPostGIS 2.0では動作しなくなりました。解消するにはどうすればよいでしょうか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>PostGIS 2.0で、多数の非推奨関数がPostGISコードから削除されました。これは、GeoServer, MapServer, QuantumGIS, OpenJump等のサードバーティツールに加えて、アプリケーションにも影響が出ます。これを解決する方法が二つあります。サードパーティアプリケーションの場合は、これらの問題の多くが解決されている最新版にアップグレードしてみることで対応できます。 ご自身のコードの場合は、削除された関数を使わないようにソースを変更することで対応できます。 削除された関数のほとんどは、ST_Unino, ST_Length等のエイリアスで、ST_を取ったものです。最後の手段として<code class="varname">legacy.sql</code>の全体または<code class="varname">legacy.sql</code>の必要な部分をインストールします。</p><p> <code class="varname">legacy.sql</code>ファイルはpostgis.sqlのインストール先と同じフォルダにあります。postgis.sqlとspatial_ref_sys.sqlをインストールした後、このファイルをインストールすると、削除した200余の関数を復帰させられます。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="legacy_faq_gist"></a><a name="idp70691456"></a><p><b>9.3.</b></p></td><td align="left" valign="top"><p>osm2pgsqlを使ってOpenStreetMapデータをロードするときに、failed: ERROR: operator class "gist_geometry_ops" does not exist for access method "gist"というエラーが発生しました。PostGIS 1.5では正しく動作していました。</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>PostGIS 2では、デフォルトのジオメトリ演算子クラスがgist_geometry_opsからgist_geometry_ops_2dに変更され、gist_geometry_opsは完全に削除されました。PostGIS 2は3次元対応のためN次元空間インデクスを導入しました。古い名前は混乱させるものであり、誤称であると考えました。</p><p>古いアプリケーションには、処理の一部として、テーブルやインデクスを生成する際に、明示的に演算子クラス名を参照しているものがありました。デフォルトの2次元インデクスが欲しい場合には重要ではありません。エラーが内容に管理するために、インデクス生成を次に示す悪い例から良い例に変えて下さい。</p><p>悪い例</p><pre class="programlisting">CREATE INDEX idx_my_table_geom ON my_table USING gist(geom gist_geometry_ops);</pre><p>良い例</p><pre class="programlisting">CREATE INDEX idx_my_table_geom ON my_table USING gist(geom);</pre><p>演算子クラスを指定する必要が出るのは、3次元空間が求められる場合です。次のようにします。</p><pre class="programlisting">CREATE INDEX idx_my_super3d_geom ON my_super3d USING gist(geom gist_geometry_ops_nd);</pre><p>不幸にもgist_geometry_opsがハードコーディングされていて変更不可なコンパイルされたコードを突きつけられているなら、PostGIS 2.0.2以上に同梱されている<code class="filename">legacy_gist.sql</code>を使用して、古いクラスを生成することができます。しかしながら、この方法を使う場合は、後ほどインデクスを削除して、演算子クラスを指定せずに再生成させるべきです。将来再びアップデートする必要がある時に泣いてしまうことを抑制します。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="legacy_faq_read_view"></a><a name="idp70709760"></a><p><b>9.4.</b></p></td><td align="left" valign="top"><p>PostgreSQL 9.0を使っていますが、OpenJump、Safe FME等のツールでジオメトリの読み取りや表示ができなくなってしまいましたが?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>PostgreSQL 9.0以上では、byteaデータのデフォルトのエンコーディングがhexに変更されました。古いJDBCドライバはエスケープ形式を仮定しています。古いJDBCドライバを使ったJavaアプリケーションや古いNpgsqlドライバを使った.Netアプリケーションといった、ST_AsBinaryの古い挙動を期待するアプリケーションが影響を受けます。再び動作させるには二つの方法があります。</p><p>JDBCドライバを最新のPostgreSQL 9.0版にアップグレードします。<a class="ulink" href="http://jdbc.postgresql.org/download.html" target="_top">http://jdbc.postgresql.org/download.html</a>からダウンロードできます。</p><p>.Netアプリケーションについては、Npgsql 2.0.11以上を使います。<a class="ulink" href="http://pgfoundry.org/frs/?group_id=1000140" target="_top">http://pgfoundry.org/frs/?group_id=1000140</a>からダウンロードできます。また、<a class="ulink" href="http://fxjr.blogspot.com/2010/11/npgsql-2011-released.html" target="_top">Francisco Figueiredo's NpgSQL 2.0.11 released blog entry</a>に説明があります。</p><p>PostgreSQLドライバのアップグレードが選択できないなら、デフォルトで古い挙動をするようにします。次のようにします。</p><pre class="programlisting">ALTER DATABASE mypostgisdb SET bytea_output='escape';</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="pgadmin_shows_no_data_in_geom"></a><a name="idp70715008"></a><p><b>9.5.</b></p></td><td align="left" valign="top"><p>pgAdminを使ってジオメトリカラムを表示しようとしたら空っぽでした。何か方法はありませんか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>pgAdminは大きなジオメトリを表示しません。ジオメトリカラムがそうなっていないかを確かめる最善の方法は次の通りです。</p><pre class="programlisting">-- 全てのgeomカラムに値が入っている場合にはレコードが返りません
SELECT somefield FROM mytable WHERE geom IS NULL;</pre><pre class="programlisting">-- ジオメトリがどれぐらい大きいかを調べるには
-- ジオメトリカラムの中でジオメトリごとに、それが持つポイントの数を
-- 尋ねるかたちのクエリを実行します
SELECT MAX(ST_NPoints(geom)) FROM sometable;</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70717696"></a><a name="idp70717952"></a><p><b>9.6.</b></p></td><td align="left" valign="top"><p>どの種類のジオメトリオブジェクトを格納できますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>ポイント、ラインストリング、ポリゴン、マルチポイント、マルチラインストリング、マルチポリゴン、ジオメトリコレクションです。PostGIS 2.0以上では、基本ジオメトリタイプとしてTINと多面体サーフェスも格納できます。これらはOpen GIS Well Known Text形式(XYZ, XYM, XYZM拡張付き)で指定されます。現在サポートされているのは3つのデータ型です。計測に平面座標系を使う標準OGCジオメトリデータ型があります。また、地理座標系を使い、球面または回転楕円体面上の計算を行うジオグラフィデータ型があります。最新のPostGIS空間型群に追加されたのが、ラスタデータの格納と解析に使われるラスタ型です。ラスタ型単独で「よくある質問」を用意しています。詳細については<a class="xref" href="RT_FAQ.html" title="第13章 PostGISラスタ よくある質問">13章<i>PostGISラスタ よくある質問</i></a>と<a class="xref" href="RT_reference.html" title="第12章 ラスタ リファレンス">12章<i>ラスタ リファレンス</i></a>をご覧ください。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70720384"></a><a name="idp70720640"></a><p><b>9.7.</b></p></td><td align="left" valign="top"><p>たいへん混乱しました。ジオメトリとジオグラフィのどちらを使うべきでしょうか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>短い答: ジオグラフィは長距離の測定をサポートする新しいデータ型ですが、計算速度は現在のところジオメトリの計算より遅いです。ジオグラフィを使う場合は、平面座標系についてあまり多く学習する必要がありません。行うことが距離や長さの計測に限定され、かつ世界中からのデータを持っている場合は、一般的にジオグラフィが最善です。ジオメトリは古いデータ型で、サポートする関数が多く、サードパーティからの多大なサポートが得られます。計算速度も早く、大きなジオメトリでは10倍違います。空間参照系に慣れているか、<a class="link" href="using_postgis_dbmanagement.html#spatial_ref_sys" title="4.5. 空間参照系">空間参照系 (SRID)</a>が単一で済むような局所的なデータを扱っているか、あるいは、空間処理を多く行う必要がある場合には、ジオメトリが最善です。ご注意: 簡単に二つの型の相互変換を行ってそれぞれの利点を得ることができます。現在サポートされているもの、サポートされていないものについては<a class="xref" href="PostGIS_Special_Functions_Index.html#PostGIS_TypeFunctionMatrix" title="15.11. PostGIS関数対応マトリクス">「PostGIS関数対応マトリクス」</a>を参照して下さい。 </p><p> 長い答: <a class="xref" href="using_postgis_dbmanagement.html#PostGIS_GeographyVSGeometry" title="4.3.3. ジオグラフィ型を使用すべき時">「ジオグラフィ型を使用すべき時」</a>と<a class="link" href="PostGIS_Special_Functions_Index.html#PostGIS_TypeFunctionMatrix" title="15.11. PostGIS関数対応マトリクス">function type matrix</a>とを参照して下さい。 </p></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70724608"></a><a name="idp70724864"></a><p><b>9.8.</b></p></td><td align="left" valign="top"><p>もっとジオグラフィについて聞きたいです。 たとえば、ジオグラフィカラムにデータを入れて合理的な答えが得られる領域範囲はどれぐらいでしょうか、とか。極、全データが半球上になければならないのでしょうか(SQL Server 2008はそう)、速度等の制限はあるのでしょうか、とか。</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>その質問は相当深く複雑で、このセクションで十分に答えられません。<a class="xref" href="using_postgis_dbmanagement.html#PostGIS_Geography_AdvancedFAQ" title="4.3.4. ジオグラフィに関する高度なよくある質問">「ジオグラフィに関する高度なよくある質問」</a>を参照して下さい。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="faq_how_to_define_geometry_table"></a><a name="idp70727296"></a><p><b>9.9.</b></p></td><td align="left" valign="top"><p>GISオブジェクトをデータベースに挿入するにはどうしますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>まず、GISデータを保持するために"geometry"または"geogprahy"カラムを持つテーブルを作成します。ジオグラフィデータ型の格納は、ジオメトリデータ型とは若干異なります。ジオグラフィの格納については<a class="xref" href="using_postgis_dbmanagement.html#PostGIS_Geography" title="4.3. ジオグラフィデータタイプ">「ジオグラフィデータタイプ」</a>を参照して下さい。 </p><p>ジオメトリについては、psqlでデータベースに接続して、次のSQLを試してみて下さい。</p><pre class="programlisting">CREATE TABLE gtest (id serial primary key, name varchar(20), geom geometry(LINESTRING));</pre><p>ジオメトリカラムの追加に失敗する場合は、もしかしたらPostGISの関数とオブジェクトをデータベースにロードしていないか、2.0より前の版のPostGISなのかも知れません。<a class="xref" href="postgis_installation.html#PGInstall" title="2.2. ソースからのコンパイルとインストール">「ソースからのコンパイルとインストール」</a>を参照して下さい。</p><p>これで、SQLのINSERTステートメントを使って、ジオメトリをテーブルに挿入することができます。GISオブジェクト自体は、OpenGISコンソーシアムの"well-known text"形式を使っています。</p><pre class="programlisting">INSERT INTO gtest (ID, NAME, GEOM)
VALUES (
  1,
  'First Geometry',
  ST_GeomFromText('LINESTRING(2 3,4 5,6 5,7 8)')
);</pre><p>他のGISオブジェクトの詳細については<a class="link" href="using_postgis_dbmanagement.html#RefObject" title="4.1. 空間データ モデル">object reference</a>をご覧ください。</p><p>テーブル内にあるGISデータを表示するには、次のようにします。</p><pre class="programlisting">SELECT id, name, ST_AsText(geom) AS geom FROM gtest;</pre><p>返り値は次のようなかんじになります。</p><pre class="programlisting">id | name           | geom
----+----------------+-----------------------------
  1 | First Geometry | LINESTRING(2 3,4 5,6 5,7 8)
(1 row)</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70734848"></a><a name="idp70735104"></a><p><b>9.10.</b></p></td><td align="left" valign="top"><p>空間クエリを作成するにはどうするのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>他のデータベースクエリを作るのと同じで、返り値、関数、テストのSQLの組み合わせです。</p><p>空間クエリでは、クエリを作成する際に心を平静に保つための重要な二つの問題があります。 一つは、使用することができる空間インデクスがあるか、です。もう一つは、多数のジオメトリを相手に計算量の多い計算を行っているか、です。</p><p>一般的に、フィーチャーのバウンディングボックスがインタセクト (交差)しているかをテストするインタセクト演算子 (&amp;&amp;)を使います。&amp;&amp;演算子が便利な理由は、速度向上のために空間インデクスが付けられているなら、&amp;&amp;演算子は空間インデクスを使うからです。これによって、クエリの速度はとてもとても速くなります。</p><p>また、検索結果をより狭めるために、Distance(), ST_Intersects(), ST_Contains(), ST_Within() などといった空間関数を使うことでしょう。ほとんどの空間クエリは、インデクスのテストと空間関数のテストを含みます。インデクスのテストで返ってくるタプルを、求める条件に<span class="emphasis"><em>合致するかもしれない</em></span>タプルのみとして、タプルの数を制限します。それから、空間関数で確実な条件のテストを行います。</p><pre class="programlisting">SELECT id, geom
FROM thetable
WHERE
  ST_Contains(geom,'POLYGON((0 0, 0 10, 10 10, 10 0, 0 0))');</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70743040"></a><a name="idp70743296"></a><p><b>9.11.</b></p></td><td align="left" valign="top"><p>大きなテーブルでの空間クエリの速度向上はどうするのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>大きなテーブルの速いクエリは、空間データベースの<span class="emphasis"><em>レゾンデートル</em></span> (トランザクションサポートもそうですが)で、良いインデクスは重要です。</p><p><code class="varname">geometry</code>カラムを持つテーブルでの空間インデクスの構築は、"CREATE INDEX"を使って、次のようにします。</p><pre class="programlisting">CREATE INDEX [インデクス名] ON [テーブル名] USING GIST ( [ジオメトリカラム] );</pre><p>"USING GIST"オプションによって、サーバにGiST (Generalized Search Tree)インデクスを作るよう指示が渡ります。</p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>GiSTインデクスは、不可逆であると仮定します。不可逆インデクスの構築には、代理オブジェクト (空間インデクスの場合はバウンディングボックス)を使います。</p></td></tr></table></div><p>PostgreSQLのクエリプランナがインデクスを作るべきかについて合理的な決定を行うよう、十分な情報を確実に持てるようにすべきです。そのために、ジオメトリテーブル上で"gather statistics"を実行しなければなりません。</p><p>PostgreSQL 8.0.x以上では、<span class="command"><strong>VACUUM ANALYZE</strong></span>コマンドを実行するだけです。</p><p>PostgreSQL 7.4.x以下では、<span class="command"><strong>SELECT UPDATE_GEOMETRY_STATS()</strong></span>を実行します。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70753920"></a><a name="idp70754176"></a><p><b>9.12.</b></p></td><td align="left" valign="top"><p>なぜPostgreSQLのR木インデクス機能を持たないのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>PostGISの、かつての版では、PostgreSQLのR木インデクスを使っていましたが、0.6版でPostgreSQLのR木は完全に捨てて、R-Tree-over-GiSTスキームによる空間インデクスを提供しています。</p><p>私たちの試験では、R木とGiSTの検索速度は同程度であることが示されています。PostgreSQLのR木には、GISフィーチャーで使うためには好ましくない二つの制限があります (これらの制限は現在のPostgreSQLネイティブのR木実装についてであって、R木一般の話ではありません)。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>PostgreSQLのR木インデクスは、8K以上のサイズのフィーチャーは扱えません。GiSTインデクスはフィーチャー自体の代わりにバウンディングボックスを用いる「不可逆」トリックを使っているので扱うことができます。</p></li><li class="listitem"><p>PostgreSQLのR木インデクスは「NULLセーフ」ではなく、NULLジオメトリを含むジオメトリカラムではインデクス作成に失敗します。</p></li></ul></div></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70758144"></a><a name="idp70758400"></a><p><b>9.13.</b></p></td><td align="left" valign="top"><p>なぜ <code class="varname">AddGeometryColumn()</code>関数と他のOpsnGIS関数を使うべきなのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>OpenGIS関数を使いたくないのでしたら、使う必要はありません。単純にジオメトリカラムをCREATEステートメントで定義する古いやり方で作成して下さい。全てのジオメトリはSRIDが-1になり、OpenGISメタデータテーブルは適切に<span class="emphasis"><em>書き込まれません</em></span>。これによって、ほとんどのPostGISベースのアプリケーションでは失敗します。一般的には<code class="varname">AddGeometryColumn()</code>を用いることをお勧めします。</p><p>MapServerは<code class="varname">geometry_columns</code>メタデータを使うアプリケーションのひとつです。踏み込んでいえば、MpaServerはジオメトリカラムのSRIDを使って、正しい地図投影へのフィーチャーの自動投影変換を行います。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70762112"></a><a name="idp70762368"></a><p><b>9.14.</b></p></td><td align="left" valign="top"><p>半径内にあるオブジェクトを全て検索する最善の方法は何ですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>データベースを最も効果的に使うには、半径検索とバウンディングボックス検索を組み合わせた半径検索を行うのが最も良いです。バウンディングボックス検索で空間インデクスを使用するので、半径検索が適用されるサブセットへのアクセスが早くなります。</p><p><code class="varname">ST_DWithin(geometry, geometry, distance)</code>関数は、インデクス付きの距離検索を実行する手軽な方法です。この関数は、距離半径を十分に含む大きさの検索矩形を作成して、 インデクス付きの結果サブセットに対して確実な距離検索を行います。</p><p>たとえば、POINT(1000 1000)から100メートル内の全てのオブジェクトを見つけるためには、次のクエリで動作します。</p><pre class="programlisting">SELECT * FROM geotable
WHERE ST_DWithin(geocolumn, 'POINT(1000 1000)', 100.0);</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70765568"></a><a name="idp70765824"></a><p><b>9.15.</b></p></td><td align="left" valign="top"><p>クエリの一部として投影変換を実現するにはどうしますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>投影変換を実行するには、変換前座標系と変換後座標系の両方がSPATIAL_REF_SYSテーブル上に定義されていて、かつ、変換されるジオメトリはSRIDが設定されている必要があります。それが完了していると、投影変換は変換後SRIDを参照する程度の手間で実行できます。次ではジオメトリをNAD 83経度緯度に変換していて、SRIDが未定義を示す-1 (訳注: PostGIS 2以降は0です)に設定されていないなら動作します。</p><pre class="programlisting">SELECT ST_Transform(geom,4269) FROM geotable;</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70768000"></a><a name="idp70768256"></a><p><b>9.16.</b></p></td><td align="left" valign="top"><p>ST_AsEWKTとST_AsTextとを、かなり大きいジオメトリで実行すると、空のフィールドが返りました。どうしたら良いですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>pgAdminまたは大きなテキストを表示しないその他のツールを使用しているのかも知れません。 ジオメトリが十分に大きい場合、ツールには空として表示されます。本当にWKTで見たり出力したりしなければならない場合は、PSQLを使用して下さい。</p><pre class="programlisting">-- ジオメトリが本当に存在しない行数の確認
                                SELECT count(gid) FROM geotable WHERE geom IS NULL;</pre></td></tr><tr class="question"><td align="left" valign="top"><a name="idp70770432"></a><a name="idp70770688"></a><p><b>9.17.</b></p></td><td align="left" valign="top"><p>ST_Intersectsを使うと、二つのジオメトリがインタセクトしているのが分かっているのに、インタセクトしていないと言います。どうしたら良いですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>二つの場合がよくあります。一つは、ジオメトリが不正な場合です。<a class="xref" href="">???</a>で確認できます。もう一つは、ST_AsTextで数字を切り捨てていて、表示されている分より後にたくさんの小数が付いている場合です。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="license_faq"></a><a name="idp70773120"></a><p><b>9.18.</b></p></td><td align="left" valign="top"><p>PostGISを用いたソフトウェアをリリースしています。PostGISのようにGPLライセンスを使う必要があるのでしょうか?PostGISを使うとコードを全て公開しなければならないのでしょうか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>ほぼ確実に違います。 例として、Linux上で動作するOracleを考えてみます。 LinuxはGPLでOracleは違いますが、Linuxで動作するOracleはGPLで配布しなければならないでしょうか?違います。あなたのソフトウェアはPostgreSQL/PostGISデータベースを好きなだけ使うことができ、ライセンスは好きなようにできます。</p><p>PostGISソースコードに変更を加えて、変更したPostGISを配布したときだけは例外です。この場合、変更したPostGISのコードを共有しなければなりません (PostGIS上で動作するアプリケーションのコードではありません)。この限られた場合でも、ソースコードはバイナリの配布相手にだけ配布します。GPLはソースコードの<span class="emphasis"><em>公開</em></span>までは求めておらず、バイナリを配布した相手との共有を求めています。</p><p>CGALを使った関数とともにPostGISを使ってでも、このことに違いはありません。CGALのライセンスの一つにGPLがありますが、PostGISの全てが既にGPLですので、CGALによってPostGISの元々のライセンスよりも厳しくなることはありません。</p></td></tr><tr class="question"><td align="left" valign="top"><a name="overlay_inconsistent"></a><a name="idp70776320"></a><p><b>9.19.</b></p></td><td align="left" valign="top"><p>オーバレイ操作と空間述語の結果が時々矛盾するのはなぜですか ?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>これは次のように特定のケースとして表せます。 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>なぜ<code class="varname">ST_Contains( A, ST_Intersection(A, B) )</code>がFALSEになるのですか ?</p></li><li class="listitem"><p>なぜ<code class="varname">ST_Contains( ST_Union(A, B), A ) )</code>がFALSEになるのですか ?</p></li><li class="listitem"><p>なぜ<code class="varname">ST_Union( A, ST_Difference(A, B) )</code>とAが同じにならないのですか ?</p></li><li class="listitem"><p>なぜ<code class="varname">ST_Difference(A, B)</code>が<code class="varname">B</code>とインタセクトしないのでしょうか ?</p></li></ul></div><p>これは、PostGISが有限精度の浮動小数点数を使ってジオメトリを表現し、操作を実行しているためです。このため、実数を使う計算で錯覚を引き起こしますが、錯覚にすぎません、必然的に、不正確の小さい問題が発生するため、異なる操作の結果の間で若干矛盾することになります。 </p><p>さらに、PostGISの操作には、エラー回避コードが含まれていて、そのコードは、堅牢性エラーを防ぐために少量で入力ジオメトリを混乱させることがあります。これらの小さな変更でも、完全な一貫性を持たない結果を算出する原因となりえます。 </p><p>結果の差は、常に、ごく小さいものです。しかし、オーバレイ結果を比較する時に、クエリは正確に矛盾が無いことを前提にすべきではありません。代わりに、幾何的比較で面積や距離の許容値を使用することを検討して下さい。 </p></td></tr></tbody></table></div></div><div class="navfooter"><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="UnlockRows.html">戻る</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="Topology.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">UnlockRows </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 第10章 トポロジ</td></tr></table></div></body></html>
