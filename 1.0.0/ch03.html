<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>第3章 よくある質問</title><link rel="stylesheet" type="text/css" href="style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"><link rel="home" href="index.html" title="PostGISマニュアル"><link rel="up" href="index.html" title="PostGISマニュアル"><link rel="prev" href="ch02.html" title="第2章 インストール"><link rel="next" href="ch04.html" title="第4章 PostGISを使う"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第3章 よくある質問</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch02.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch04.html">次へ</a></td></tr></table><hr></div><div class="chapter" title="第3章 よくある質問"><div class="titlepage"><div><div><h2 class="title"><a name="idp63337032"></a>第3章 よくある質問</h2></div></div></div><div class="qandaset" title="よくある質問"><a name="idp63337672"></a><dl><dt>3.1. <a href="ch03.html#idp63337928">どの種類のジオメトリオブジェクトを格納できますか?</a></dt><dt>3.2. <a href="ch03.html#idp63352136">GISオブジェクトをデータベースに挿入するにはどうしますか?</a></dt><dt>3.3. <a href="ch03.html#idp63372104">空間クエリを作成するにはどうするのですか?</a></dt><dt>3.4. <a href="ch03.html#idp63380424">大きなテーブルでの空間クエリの速度向上はどうするのですか?</a></dt><dt>3.5. <a href="ch03.html#idp63387208">なぜPostgreSQLのR木インデックス機能を持たないのですか?</a></dt><dt>3.6. <a href="ch03.html#idp63395528">なぜ AddGeometryColumn()関数と他のOpsnGIS関数を使うべきなのですか?</a></dt><dt>3.7. <a href="ch03.html#idp63399496">半径内にあるオブジェクトを全て検索する最善の方法は何ですか?</a></dt><dt>3.8. <a href="ch03.html#idp63402952">クエリの一部として投影変換を実現するにはどうしますか?</a></dt></dl><table border="0" width="100%" summary="Q and A Set"><col align="left" width="1%"><col><tbody><tr class="question" title="3.1."><td align="left" valign="top"><a name="idp63337928"></a><a name="idp63338184"></a><p><b>3.1.</b></p></td><td align="left" valign="top"><p>どの種類のジオメトリオブジェクトを格納できますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>ポイント、ライン、ポリゴン、マルチポイント、マルチライン、マルチポリゴン、ジオメトリコレクションを格納できます。これらは Open GIS Well Known Text Formatで規定されています (XYZ,XYM,XYZM拡張付き)。</p></td></tr><tr class="question" title="3.2."><td align="left" valign="top"><a name="idp63352136"></a><a name="idp63352392"></a><p><b>3.2.</b></p></td><td align="left" valign="top"><p>GISオブジェクトをデータベースに挿入するにはどうしますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>まず、GISデータを保持するためにジオメトリ型のカラムをテーブルに作成する必要があります。<code class="filename">psql</code>でデータベースに接続して、次のSQLを実行します。</p><pre class="programlisting">CREATE TABLE gtest ( ID int4, NAME varchar(20) );
SELECT AddGeometryColumn('', 'gtest','geom',-1,'LINESTRING',2);</pre><p>ジオメトリカラムの追加に失敗したなら、PostGIS関数とオブジェクトをそのデータベースにロードしていない可能性があります。<a class="link" href="ch02.html#PGInstall" title="2.2. PostGIS">インストール方法</a>をご覧ください。</p><p>これで、SQLのINSERTステートメントを使って、ジオメトリをテーブルに挿入することができます。GISオブジェクト自体は、OpenGISコンソーシアムの"well-known text"形式を使っています。</p><pre class="programlisting">INSERT INTO gtest (ID, NAME, GEOM) VALUES (1, 'First Geometry', GeomFromText('LINESTRING(2 3,4 5,6 5,7 8)', -1));</pre><p>GISオブジェクトの詳細については、<a class="link" href="ch04.html#RefObject" title="4.1. GISオブジェクト">オブジェクトリファレンス</a>をご覧下さい。</p><p>テーブルの中にあるGISデータを閲覧するには、次のようにします。</p><pre class="programlisting">SELECT id, name, AsText(geom) AS geom FROM gtest;</pre><p>返り値は次のようなかんじになります。</p><pre class="programlisting">id | name           | geom
----+----------------+-----------------------------
  1 | First Geometry | LINESTRING(2 3,4 5,6 5,7 8) 
(1 row)</pre></td></tr><tr class="question" title="3.3."><td align="left" valign="top"><a name="idp63372104"></a><a name="idp63372360"></a><p><b>3.3.</b></p></td><td align="left" valign="top"><p>空間クエリを作成するにはどうするのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>他のデータベースクエリを作るのと同じで、返り値、関数、テストのSQLの組み合わせです。</p><p>空間クエリでは、クエリを作成する際に心を平静に保つための重要な二つの問題があります。 一つは、使用することができる空間インデックスがあるか、です。もう一つは、多数のジオメトリを相手に計算量の多い計算を行っているか、です。</p><p>一般的に、フィーチャーのバウンディングボックスがインタセクト (交差)しているかをテストするインタセクト演算子 (&amp;&amp;)を使います。&amp;&amp;演算子が便利な理由は、速度向上のために空間インデックスが付けられているなら、&amp;&amp;演算子は空間インデックスを使うからです。これによって、クエリの速度はとてもとても速くなります。</p><p>検索結果の数を限定するために、Distance(), Intersects(), Contains(), Within()といった空間関数を使用することでしょう。ほとんどの空間クエリはインデックス検索と空間関数検索を行います。インデックス検索によって検索結果のタプルを、対象条件に適合する<span class="emphasis"><em>かもしれない</em></span>ものに制限させます。そして、空間関数は確実に条件にあうかどうかをチェックします。</p><pre class="programlisting">SELECT id, the_geom FROM thetable
WHERE
  the_geom &amp;&amp; 'POLYGON((0 0, 0 10, 10 10, 10 0, 0 0))'
AND
  Contains(the_geom,'POLYGON((0 0, 0 10, 10 10, 10 0, 0 0))';</pre></td></tr><tr class="question" title="3.4."><td align="left" valign="top"><a name="idp63380424"></a><a name="idp63380680"></a><p><b>3.4.</b></p></td><td align="left" valign="top"><p>大きなテーブルでの空間クエリの速度向上はどうするのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>大きなテーブルの速いクエリは、空間データベースの<span class="emphasis"><em>レゾンデートル</em></span> (トランザクションサポートもそうですが)で、良いインデックスは重要です。</p><p><code class="varname">geometry</code>カラムを持つテーブルでの空間インデックスの構築は、"CREATE INDEX"を使って、次のようにします。</p><pre class="programlisting">CREATE INDEX [インデックス名] ON [テーブル名] 
USING GIST ( [ジオメトリカラム] );</pre><p>"USING GIST"オプションによって、サーバにGiST (Generalized Search Tree)インデックスを作るよう指示が渡ります。</p><div class="note" title="注記" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">注記</h3><p>GiSTインデックスは、不可逆であると仮定します。不可逆インデックスの構築には、代理オブジェクト (空間インデックスの場合はバウンディングボックス)を使います。</p></div><p>PostgreSQLのクエリプランナがインデックスを作るべきかについて合理的な決定を行うよう、十分な情報を確実に持てるようにすべきです。そのために、ジオメトリテーブル上で"gather statistics"を実行しなければなりません。</p><p>PostgreSQL 8.0.x以上では、<span class="command"><strong>VACUUM ANALYZE</strong></span>コマンドを実行するだけです。</p><p>PostgreSQL 7.4.x以下では、<span class="command"><strong>SELECT UPDATE_GEOMETRY_STATS()</strong></span>を実行します。</p></td></tr><tr class="question" title="3.5."><td align="left" valign="top"><a name="idp63387208"></a><a name="idp63387464"></a><p><b>3.5.</b></p></td><td align="left" valign="top"><p>なぜPostgreSQLのR木インデックス機能を持たないのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>PostGISの、かつての版では、PostgreSQLのR木インデックスを使っていましたが、0.6版でPostgreSQLのR木は完全に捨てて、R-Tree-over-GiSTスキームによる空間インデックスを提供しています。</p><p>私たちの試験では、R木とGiSTの検索速度は同程度であることが示されています。PostgreSQLのR木には、GISフィーチャーで使うためには好ましくない二つの制限があります (これらの制限は現在のPostgreSQLネイティブのR木実装についてであって、R木一般の話ではありません)。</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>PostgreSQLのR木インデックスは、8K以上のサイズのフィーチャーは扱えません。GiSTインデックスはフィーチャー自体の代わりにバウンディングボックスを用いる「不可逆」トリックを使っているので扱うことができます。</p></li><li class="listitem"><p>PostgreSQLのR木インデックスは「NULLセーフ」ではなく、NULLジオメトリを含むジオメトリカラムではインデックス作成に失敗します。</p></li></ul></div></td></tr><tr class="question" title="3.6."><td align="left" valign="top"><a name="idp63395528"></a><a name="idp63395784"></a><p><b>3.6.</b></p></td><td align="left" valign="top"><p>なぜ <code class="varname">AddGeometryColumn()</code>関数と他のOpsnGIS関数を使うべきなのですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>OpenGIS関数を使いたくないのでしたら、使う必要はありません。単純にジオメトリカラムをCREATEステートメントで定義する古いやり方で作成して下さい。全てのジオメトリはSRIDが-1になり、OpenGISメタデータテーブルは適切に<span class="emphasis"><em>書き込まれません</em></span>。これによって、ほとんどのPostGISベースのアプリケーションでは失敗します。一般的には<code class="varname">AddGeometryColumn()</code>を用いることをお勧めします。</p><p>MapServerは<code class="varname">geometry_columns</code>メタデータを使うアプリケーションのひとつです。踏み込んでいえば、MpaServerはジオメトリカラムのSRIDを使って、正しい地図投影へのフィーチャーの自動投影変換を行います。</p></td></tr><tr class="question" title="3.7."><td align="left" valign="top"><a name="idp63399496"></a><a name="idp63399752"></a><p><b>3.7.</b></p></td><td align="left" valign="top"><p>半径内にあるオブジェクトを全て検索する最善の方法は何ですか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>データベースを最も効果的に使うには、半径検索とバウンディングボックス検索を組み合わせた半径検索を行うのが最も良いです。バウンディングボックス検索で空間インデックスを使用するので、半径検索が適用されるサブセットへのアクセスが早くなります。</p><p><code class="varname">Expand()</code>関数は、検索対象領域のインデックス検索を可能にするためにバウンディングボックスを拡大させる手軽な方法です。速いインデックスへのアクセスの句と遅い高精度距離テストとの組み合わせで、このクエリにおける、速さと精度の最も良い組み合わせが得られます。</p><p>たとえば、POINT(1000 1000)から100メートル内の全てのオブジェクトを見つけるためには、次のクエリで動作します。</p><pre class="programlisting">SELECT * 
FROM GEOTABLE 
WHERE 
  GEOCOLUMN &amp;&amp; Expand(GeomFromText('POINT(1000 1000)',-1),100)
AND
  Distance(GeomFromText('POINT(1000 1000)',-1),GEOCOLUMN) &lt; 100;</pre></td></tr><tr class="question" title="3.8."><td align="left" valign="top"><a name="idp63402952"></a><a name="idp63403208"></a><p><b>3.8.</b></p></td><td align="left" valign="top"><p>クエリの一部として投影変換を実現するにはどうしますか?</p></td></tr><tr class="answer"><td align="left" valign="top"></td><td align="left" valign="top"><p>投影変換を行うには、変換元と変換先双方の座標系がSPATIAL_REF_SYSテーブルに定義されていて、かつ投影変換されるジオメトリがそのSRIDを持っている必要があります。これが行われていると、投影変換は求める変換先SRIDを参照するのと同じぐらい簡単です。</p><pre class="programlisting">SELECT Transform(GEOM,4269) FROM GEOTABLE;</pre></td></tr></tbody></table></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch02.html">戻る</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ch04.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">第2章 インストール </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 第4章 PostGISを使う</td></tr></table></div></body></html>
