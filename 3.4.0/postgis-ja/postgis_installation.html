<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>第2章 PostGISインストール</title><link rel="stylesheet" type="text/css" href="docbook.css"><link rel="stylesheet" type="text/css" href="../style.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="PostGIS 3.4.0 マニュアル"><link rel="up" href="index.html" title="PostGIS 3.4.0 マニュアル"><link rel="prev" href="postgis_introduction.html" title="第1章 導入"><link rel="next" href="postgis_administration.html" title="第3章 PostGIS管理"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第2章 PostGISインストール</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="postgis_introduction.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="postgis_administration.html">次へ</a></td></tr></table></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="postgis_installation"></a>第2章 PostGISインストール</h1></div></div></div><div class="toc"><div class="toc-title">目次</div><dl class="toc"><dt><span class="sect1"><a href="postgis_installation.html#install_short_version">2.1. 簡略版</a></span></dt><dt><span class="sect1"><a href="postgis_installation.html#PGInstall">2.2. ソースからのコンパイルとインストール</a></span></dt><dd><dl><dt><span class="sect2"><a href="postgis_installation.html#install_getting_source">2.2.1. ソースの取得</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#install_requirements">2.2.2. インストール要件</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#installation_configuration">2.2.3. コンフィギュレーション</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#idp270248096">2.2.4. ビルド</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#make_install_postgis_extensions">2.2.5. PostGISエクステンションのビルドとデプロイ</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#idp270285472">2.2.6. テスト</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#idp270296992">2.2.7. インストール</a></span></dt></dl></dd><dt><span class="sect1"><a href="postgis_installation.html#installing_pagc_address_standardizer">2.3. PAGC住所標準化ツールのインストールと使用</a></span></dt><dt><span class="sect1"><a href="postgis_installation.html#loading_extras_tiger_geocoder">2.4. Tigerジオコーダのインストールとアップグレードとデータロード</a></span></dt><dd><dl><dt><span class="sect2"><a href="postgis_installation.html#install_tiger_geocoder_extension">2.4.1. TigerジオコーダをPostGISデータベースで有効にする</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#tiger_pagc_address_standardizing">2.4.2. TigerジオコーダをPostGISデータベースで有効にする: エクステンションを使用</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#tiger_geocoder_required_tools">2.4.3. Tigerデータのロードに必要なツール</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#upgrade_tiger_geocoder">2.4.4. Tigerジオコーダとデータのアップグレード</a></span></dt></dl></dd><dt><span class="sect1"><a href="postgis_installation.html#idp270423840">2.5. 共通の問題</a></span></dt></dl></div><p>本章では、PostGISのインストールに必要な手順について説明します。 </p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="install_short_version"></a>2.1. 簡略版</h2></div></div></div><p>全ての依存がパスに入っているとする場合、次のようにコンパイルします。</p><pre class="programlisting">tar -xvfz postgis-3.4.0.tar.gz
cd postgis-3.4.0
./configure
make
make install</pre><p>PostGISをインストールした後は、利用したいデータベース個々内で利用可能にする (<a class="xref" href="postgis_administration.html#create_spatial_db" title="3.3. 空間データベースの作成">「空間データベースの作成」</a>)か、アップグレード (<a class="xref" href="postgis_administration.html#upgrading" title="3.4. 空間データベースのアップグレード">「空間データベースのアップグレード」</a>)する必要があります。 </p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="PGInstall"></a>2.2. ソースからのコンパイルとインストール</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="postgis_installation.html#install_getting_source">2.2.1. ソースの取得</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#install_requirements">2.2.2. インストール要件</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#installation_configuration">2.2.3. コンフィギュレーション</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#idp270248096">2.2.4. ビルド</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#make_install_postgis_extensions">2.2.5. PostGISエクステンションのビルドとデプロイ</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#idp270285472">2.2.6. テスト</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#idp270296992">2.2.7. インストール</a></span></dt></dl></div><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>多くのOSで、ビルドされたPostgreSQL/PostGISパッケージがあります。多くの場合、コンパイルが必要なのは、最もひどい最先端の版が欲しい場合やパッケージメンテナンスを行う人ぐらいです。 </p><p>本節では、一般的なコンパイル手順を示します。Windows用や他のOS用等にコンパイルするなら、<a class="ulink" href="https://trac.osgeo.org/postgis/wiki/UsersWikiInstall" target="_top">PostGIS User contributed compile guides</a>や<a class="ulink" href="http://trac.osgeo.org/postgis/wiki/DevWikiMain" target="_top">PostGIS Dev Wiki</a>で、より詳細な助けが見つかるかも知れません。</p><p>多くのOS用のビルド済みパッケージの一覧は<a class="ulink" href="http://trac.osgeo.org/postgis/wiki/UsersWikiPackages" target="_top">PostGIS Pre-built Packages</a>にあります。</p><p>Windowsユーザの場合は、スタックビルダか、<a class="ulink" href="http://www.postgis.org/download/windows/" target="_top">PostGIS Windows download site</a>から安定版を得ることができます。また、週に1回か2回のビルドと刺激的なことがあった時の随時ビルドとを行っている<a class="ulink" href="https://postgis.net/windows_downloads" target="_top">very bleeding-edge windows experimental builds</a>もあります。これらはPostGISの進行中のリリースでの試験に使用します。</p></td></tr></table></div><p>PostGISモジュールは、PostgreSQLバックエンドサーバの拡張です。PostGIS 3.4.0では、コンパイルのために、完全なPostgreSQLサーバヘッダが<span class="emphasis"><em>必要です</em></span>。PostgreSQL 12 - 16の間でビルドできます。古い版のPostgreSQLは<span class="emphasis"><em>サポートされません</em></span>。 </p><p>PostgreSQLをインストールしていないならPostgreSQLインストールガイドを参照して下さい。<a class="ulink" href="http://www.postgresql.org/" target="_top">http://www.postgresql.org/</a>にあります。 </p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>GEOS機能を有効にするために、PostgreSQLをインストール時に明示的に標準C++ライブラリに対する明示的なリンクが必要になる場合があります。 </p><pre class="programlisting">LDFLAGS=-lstdc++ ./configure [YOUR OPTIONS HERE]</pre><p>これは、古い開発ツールとインチキC++例外との対話のための応急処置です。怪しい問題 (望んでいないのにバックエンドが閉じたりそれに近い挙動を起こす)を経験したなら、このトリックを試してみて下さい。もちろん、これを行うにはPostgreSQLをはじめからコンパイルし直す必要があります。 </p></td></tr></table></div><p>次のステップでは、PostGISソースのコンフィギュレーションとコンパイルに概要を記述します。これらは、Linuxユーザ用に書いてありますので、WindowsやMacでは動作しません。 </p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="install_getting_source"></a>2.2.1. ソースの取得</h3></div></div></div><p>ダウンロードサイト<a class="ulink" href="https://download.osgeo.org/postgis/source/postgis-3.4.0.tar.gz" target="_top"> https://download.osgeo.org/postgis/source/postgis-3.4.0.tar.gz </a>からソースのアーカイブを入手します。 </p><pre class="programlisting">wget https://download.osgeo.org/postgis/source/postgis-3.4.0.tar.gz
tar -xvzf postgis-3.4.0.tar.gz
cd postgis-3.4.0</pre><p>これで、カレントディレクトリの下に<code class="varname">postgis-3.4.0</code>ができます。 </p><p>もしくは <a class="ulink" href="https://git-scm.com/" target="_top"> git </a>レポジトリ<a class="ulink" href="https://git.osgeo.org/gitea/postgis/postgis/" target="_top"> https://git.osgeo.org/gitea/postgis/postgis/ </a>からチェックアウトします。 </p><pre class="programlisting">git clone https://git.osgeo.org/gitea/postgis/postgis.git postgis
cd postgis
sh autogen.sh
    </pre><p>新しく作られた<code class="varname">postgis</code>ディレクトトリに移動して、インストールを続けます。 </p><pre class="programlisting">./configure</pre></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="install_requirements"></a>2.2.2. インストール要件</h3></div></div></div><p>PostGISのビルドと利用のために、次のものが必要です。 </p><p>
	  <span class="bold"><strong>必須</strong></span>
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>PostgreSQL 12 - 16。PostgreSQLの完全なインストール (サーバヘッダを含む)が必要です。PostgreSQLは<a class="ulink" href="http://www.postgresql.org/" target="_top"> http://www.postgresql.org/</a>にあります。 </p><p>完全なPosgreSQL/PostGIS対応表とPostGIS/GEOS対応表については<a class="ulink" href="http://trac.osgeo.org/postgis/wiki/UsersWikiPostgreSQLPostGIS" target="_top">http://trac.osgeo.org/postgis/wiki/UsersWikiPostgreSQLPostGIS</a>をご覧ください。 </p></li><li class="listitem"><p>GNU Cコンパイラ (<code class="filename">gcc</code>)。ANSI Cコンパイラの中には、PostGISをコンパイルできるものもありますが、<code class="filename">gcc</code>でコンパイルするのが最も問題が少ないと見ています。 </p></li><li class="listitem"><p>GNU Make (<code class="filename">gmake</code>または<code class="filename">make</code>)。多くのシステムで、GNU <code class="filename">make</code>がデフォルトのmakeになっています。<code class="filename">make -v</code>を実行して版を確認して下さい。他版の<code class="filename">make</code>では、PostGISの<code class="filename">Makefile</code>を完全に処理しきれないかもしれません。 </p></li><li class="listitem"><p>投影変換ライブラリProj。Proj 6.1以上が必要です。Projライブラリは、PostGISの座標系投影変換機能に使われます。Projは<a class="ulink" href="https://proj.org/" target="_top"> https://proj.org/ </a>からダウンロードできます。 </p></li><li class="listitem"><p>ジオメトリライブラリGEOS、3.6以上が必要ですが、全ての関数と機能の利点を完全に得るにはGEOS 3.12以上が必要です。GEOSは<a class="ulink" href="https://libgeos.org/" target="_top"> https://libgeos.org/ </a>からダウンロードできます。 </p></li><li class="listitem"><p>LibXML2, 2.5.x以上。現在は、LibXML2はインポート関数 (ST_GeomFromGMLとST_GeomFromKML)で使われています。LibXML2は<a class="ulink" href="https://gitlab.gnome.org/GNOME/libxml2/-/releases" target="_top">https://gitlab.gnome.org/GNOME/libxml2/-/releases</a>からダウンロードできます。 </p></li><li class="listitem"><p>JSON-C 0.9以上。JSON-Cは現在、ST_GeomFromGeoJsonによるGeoJSONの取り込みに使われます。JSON-Cは<a class="ulink" href="https://github.com/json-c/json-c/releases/" target="_top">https://github.com/json-c/json-c/releases/</a>からダウンロード可能です。 </p></li><li class="listitem"><p>GDAL, version 2以上が必要で以上が好ましいです。ラスタ機能に必要です。<a class="ulink" href="https://gdal.org/download.html" target="_top">https://gdal.org/download.html</a>。 </p></li><li class="listitem"><p>PostgreSQL+JITでコンパイルする場合には、LLVM 6版以上が必要です。<a class="ulink" href="https://trac.osgeo.org/postgis/ticket/4125" target="_top">https://trac.osgeo.org/postgis/ticket/4125</a>を参照して下さい。 </p></li></ul></div><p>
	  <span class="bold"><strong>オプション</strong></span>
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>GDAL (擬似的任意)。ラスタが必要ない場合に限り不要です。<a class="xref" href="postgis_administration.html#raster_configuration" title="3.2. ラスタ機能の設定">「ラスタ機能の設定」</a>の説明に従って使用したいドライバを有効にしてください。 </p></li><li class="listitem"><p>GTK (GTK+2.0, 2.8+が必要)。シェープファイルのローダであるshp2pgsql-guiのコンパイル用です。<a class="ulink" href="http://www.gtk.org/" target="_top">http://www.gtk.org/</a>にあります。 </p></li><li class="listitem"><p>SFCGL 1.3.1 (以上)、1.4.1以上が推奨で、全ての機能を使うに必要です。SFCGALは<a class="xref" href="reference.html#reference_sfcgal" title="7.21. SFCGAL関数">「SFCGAL関数」</a>に示すような追加的な2次元や3次元の高度な解析関数をPostGISに与えることができます。GEOSと両方のバックエンドから提供される2次元関数 (ST_IntersectionやST_Areaなど)で、SFCGALを使用することもできます。SFCGALがインストールされている場合には、PostgreSQLコンフィギュレーション変数<code class="code">postgis.backend</code>を使ってエンドユーザがどちらのバックエンドを使うか選択できます (デフォルトはGEOS)。ご注意: SFCGAL 1.2は少なくともCGAL 4.3とBooset 1.54が必要です (<a class="ulink" href="https://oslandia.gitlab.io/SFCGAL/dev.html" target="_top">https://oslandia.gitlab.io/SFCGAL/dev.html</a>) <a class="ulink" href="https://gitlab.com/Oslandia/SFCGAL/" target="_top">https://gitlab.com/Oslandia/SFCGAL/</a>。 </p></li><li class="listitem"><p><a class="xref" href="Extras.html#Address_Standardizer" title="11.1. 住所標準化">「住所標準化」</a>をビルドするには、PCRE <a class="ulink" href="http://www.pcre.org" target="_top">http://www.pcre.org</a> (通常はnixシステムにはインストールされています)も必要です。PCREライブラリを検出したら<a class="xref" href="Extras.html#Address_Standardizer" title="11.1. 住所標準化">「住所標準化」</a>は自動でビルドされます。もしくは、コンフィギュアの際に有効な<code class="varname">--with-pcre-dir=/path/to/pcre</code>を指定します。 </p></li><li class="listitem"><p>ST_AsMVTを有効にするには、protobuf-cライブラリ (実行時)とprotoc-cコンパイラ (ビルド時)が必要です。protobuf-cの正しい最小版を確認するには、pkg-configが必要です。<a class="ulink" href="https://github.com/protobuf-c/protobuf-c" target="_top">protobuf-c</a>をご覧下さい。デフォルトでは、PostGISは、MVTポリゴンを高速に評価するためにWagyuを使用していますが、C++11コンパイラが必要です。CXXFLAGSを使って、PostgreSQLインストールに使ったのと同じコンパイラを使います。これを無効化してGEOSを代わりに使う場合には、コンフィギュレーション時に<code class="varname">--without-wagyu</code>を指定します。 </p></li><li class="listitem"><p>CUnit (<code class="filename">CUnit</code>)。レグレッションテストに必要です。<a class="ulink" href="http://cunit.sourceforge.net/" target="_top">http://cunit.sourceforge.net/</a>にあります。 </p></li><li class="listitem"><p>DocBook (<code class="filename">xsltproc</code>)。文書のビルドに必要です。<a class="ulink" href="http://www.docbook.org/" target="_top">http://www.docbook.org/</a>にあります。 </p></li><li class="listitem"><p>DBLatex (<code class="filename">dblatex</code>)。文書をPDFでビルドするのに必要です。<a class="ulink" href="http://dblatex.sourceforge.net/" target="_top">http://dblatex.sourcforge.net/</a>にあります。 </p></li><li class="listitem"><p>ImageMagick (<code class="filename">convert</code>)。文書で使う画像を生成するのに必要です。<a class="ulink" href="http://www.imagemagick.org/" target="_top">http://www.imagemagick.org/</a>にあります。 </p></li></ul></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="installation_configuration"></a>2.2.3. コンフィギュレーション</h3></div></div></div><p>ほとんどのLinuxのインストールと同様に、最初のステップでは、ソースコードのビルドに使われるMakefileを生成します。これは、シェルスクリプトが行います。 </p><p>
		<span class="command"><strong>./configure</strong></span>
	  </p><p>パラメータを付けない場合には、このコマンドは自動で、PostGISのソースコードのビルドを行うのに必要なコンポーネントやライブラリをシステム上で探します。<span class="command"><strong>./configure</strong></span>とするのが一般的な使い方ですが、標準的でない位置に必要なライブラリやプログラムを置いてある場合のために、いくつかのパラメータを受け付けます。 </p><p>次のリストで、共通して使われるパラメータを示します。 完全なリストについては、<span class="command"><strong>--help</strong></span>または<span class="command"><strong>--help=short</strong></span>パラメータを使って下さい。 </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="command"><strong>--with-library-minor-version</strong></span></span></dt><dd><p>PostGIS 3.0以降では、デフォルトではライブラリファイルのファイル名にマイナーバージョンが入らなくなりました。PostGIS 3のライブラリは<code class="code">postgis-3</code>で終わります。pg_upgradeを簡単にするために実施された変更ですが、サーバにPostGIS 3シリーズは一つのマイナーバージョンのものだけしかインストールできません。<code class="code">postgis-3.0</code>といったようにマイナーバージョンをファイル名に含む古い振る舞いにしたいなら、コンフィギュレーション実行の際に次のスイッチを追加します。</p></dd><dt><span class="term"><span class="command"><strong>--prefix=PREFIX</strong></span></span></dt><dd><p>PostGISライブラリとSQLスクリプトのインストール先を指定します。デフォルトでは、検出されたPostgreSQLのインストール先と同じになります。 </p><div class="caution"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="../images/caution.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>このパラメータは現在のところ壊れていて、PostgreSQLのインストール先にしかインストールされません。このバグのトラックについては<a class="ulink" href="http://trac.osgeo.org/postgis/ticket/635" target="_top">http://trac.osgeo.org/postgis/ticket/635</a>をご覧ください。 </p></td></tr></table></div></dd><dt><span class="term"><span class="command"><strong>--with-pgconfig=FILE</strong></span></span></dt><dd><p>PostgreSQLは、PostGISなどの拡張に対してPostgreSQLのインストール先ディレクトリを伝える<span class="command"><strong>pg_config</strong></span>というユーティリティを持っています。PostGISの対象とする特定のPostgreSQLのインストール先を手動で指定する場合に、このパラメータ(<span class="command"><strong>--with-pgconfig=/path/to/pg_config</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-gdalconfig=FILE</strong></span></span></dt><dd><p>必須ライブラリであるGDALは、ラスタ機能に必要な機能を提供します。GDALには、インストール先ディレクトリをインストールスクリプトに伝える<span class="command"><strong>gdal-config</strong></span>があります。PostGISのビルドに使う特定のGDALを手動で指定する場合に、このパラメータ (<span class="command"><strong>--with-gdalconfig=/path/to/gdal-config</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-geosconfig=FILE</strong></span></span></dt><dd><p>必須のジオメトリライブラリであるGEOSには、ソフトウェアのインストール時にGEOSのインストール先ディレクトリを伝える<span class="command"><strong>geos-config</strong></span>というユーティリティがあります。PostGISのビルドに使う特定のGEOSを手動で指定する場合に、このパラメータ (<span class="command"><strong>--with-geosconfig=/path/to/geos-config</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-xml2config=FILE</strong></span></span></dt><dd><p>LibXMLはGeomFromKML/GML処理を行うのに必須のライブラリです。通常はlibxmlをインストールしているなら発見されますが、発見できない場合や特定の版を使用したい場合は、<code class="filename">xml2-config</code>を指定してインストールスクリプトにLibXMLのインストール先ディレクトリを伝えます。PostGISのビルドに使う特定のLibXMLを手動で指定する場合に、このパラメータ (<span class="command"><strong>
&gt;--with-xml2config=/path/to/xml2-config</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-projdir=DIR</strong></span></span></dt><dd><p>ProjはPostGISに必須の投影変換ライブラリです。PostGISのビルドに使う特定のProjのインストールディレクトリを手動で指定する場合は、このパラメータ (<span class="command"><strong>--with-projdir=/path/to/projdir</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-libiconv=DIR</strong></span></span></dt><dd><p>iconvのインストール先ディレクトリを指定します。 </p></dd><dt><span class="term"><span class="command"><strong>--with-jsondir=DIR</strong></span></span></dt><dd><p><a class="ulink" href="http://oss.metaparadigm.com/json-c/" target="_top">JSON-C</a>は、MITライセンスのJSONライブラリで、PostGISのST_GeomFromJSONに必須です。PostGISのビルドに使う特定のJSON-Cを手動で指定する場合に、このパラメータ (<span class="command"><strong>--with-jsondir=/path/to/jsondir</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-pcredir=DIR</strong></span></span></dt><dd><p><a class="ulink" href="http://www.pcre.org/" target="_top">PCRE</a>は、BSDライセンスのPerl互換正規表現ライブラリです。住所標準化エクステンションに必須です。PostGISのビルド対象としている特定のPCREを手動で指定する場合に、このパラメータ (<span class="command"><strong>--with-pcredir=/path/to/pcredir</strong></span>)を使います。 </p></dd><dt><span class="term"><span class="command"><strong>--with-gui</strong></span></span></dt><dd><p>データインポートGUI (GTK+2.0が必要)をコンパイルします。このパラメータによって、shp2pgsql-guiという、shp2pgsqlのグラフィカルユーザインタフェースが作成されます。 </p></dd><dt><span class="term"><span class="command"><strong>--without-raster</strong></span></span></dt><dd><p>ラスタ機能なしでコンパイルします。 </p></dd><dt><span class="term"><span class="command"><strong>--without-topology</strong></span></span></dt><dd><p>トポロジ対応を無くしてコンパイルします。トポロジに必要なロジックは全てpostgis-3.4.0ライブラリ内に作られるので、関連ライブラリはありません。 </p></dd><dt><span class="term"><span class="command"><strong>--with-gettext=no</strong></span></span></dt><dd><p>デフォルトでは、gettextの検出とこれを用いたコンパイルを試みますが、ローダ破損を引き起こす非互換性問題のもとで実行する場合には、このコマンドで無効にできます。これを使ったコンフィギュレーションによって解決する問題の例は<a class="ulink" href="http://trac.osgeo.org/postgis/ticket/748" target="_top">http://trac.osgeo.org/postgis/ticket/748</a>にあります。ご注意: これを切ることで多くの機能がなくなるわけではありません。まだ文書化されていなくて試験段階であるGUIローダにおける内部のヘルプ/ラベル機能に使われています。 </p></dd><dt><span class="term"><span class="command"><strong>--with-sfcgal=PATH</strong></span></span></dt><dd><p>デフォルトでは、このスイッチなしではSFCGAL対応でインストールされません。<code class="varname">PATH</code>は、sfcgal-configへのパスを指定することができる追加的な引数です。 </p></dd><dt><span class="term"><span class="command"><strong>--without-phony-revision</strong></span></span></dt><dd><p>Gitレポジトリの現在のHEADに一致するように、postgis_revision.hの更新を無効にします。 </p></dd></dl></div><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>PostGISを<a class="ulink" href="https://trac.osgeo.org/postgis/wiki/CodeRepository" target="_top">コードレポジトリ</a>から得る場合には、はじめに次のスクリプトを実行します。 </p><p>
		  <span class="command"><strong>./autogen.sh</strong></span>
		</p><p>このスクリプトによって<span class="command"><strong>configure</strong></span>スクリプトが生成されます。これはPostGISのインストールに関するカスタマイズに使われます。 </p><p>PostGISをアーカイブファイルで入手する場合には、<span class="command"><strong>configure</strong></span>が既に生成されているので<span class="command"><strong>./autogen.sh</strong></span>は不要です。 </p></td></tr></table></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp270248096"></a>2.2.4. ビルド</h3></div></div></div><p>Makefileが生成されたら、PostGISのビルドは、次のコマンドを実行するだけです。 </p><p>
		<span class="command"><strong>make</strong></span>
	  </p><p>出力の最後の行に"<code class="code">PostGIS was built successfully. Ready to install.</code>"と出れば終わりです。 </p><p>PostGIS 1.4.0版からは、全ての関数に文書から生成されるコメントが付きます。これらのコメントを後からインストールするには、次のコマンドを実行しますが、docbookが必要です。アーカイブファイルからインストールする場合は、postgis_comments.sql, raster_comments.sql, topology_comments.sqlは、docフォルダにあるので、コメントを作成する必要はありません。コメントはCREATE EXTENSIONによるインストールの一部として取り込まれます。 </p><p>
		<span class="command"><strong>make comments</strong></span>
	  </p><p>PostGIS 2.0で導入されました。早見表にも、また学習中の方のハンドアウトにも適しているHTMLチートシートを生成します。xsltprocが必要で、<code class="filename">topology_cheatsheet.html</code>, <code class="filename">tiger_geocoder_cheatsheet.html</code>, <code class="filename">raster_cheatsheet.html</code>, <code class="filename">postgis_cheatsheet.html</code>の4ファイルが生成されます。 </p><p>HTMLとPDFのビルド済みのものは<a class="ulink" href="http://www.postgis.us/study_guides" target="_top">PostGIS / PostgreSQL Study Guides</a>にあります。</p><p>
		<span class="command"><strong>make cheatsheets</strong></span>
	  </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="make_install_postgis_extensions"></a>2.2.5. PostGISエクステンションのビルドとデプロイ</h3></div></div></div><p>PostgreSQL 9.1以上を使用している場合は、PostGISエクステンションが自動的にビルド、インストールされます。 </p><p>ソースレポジトリからビルドしている場合は、関数の記述を最初にビルドする必要があります。これらは、docbookがインストールされている時にビルドされます。手動でインストールするには次のようにします。 </p><p>
	  <span class="command"><strong>make comments</strong></span>
    </p><p>アーカイブファイルからのビルドの場合は、ビルド済みのものがあるので、コメントのビルドは必須ではありません。</p><p>PostgreSQL 9.1を対象にビルドしている場合は、エクステンションは自動的にmake install処理の一部としてビルドするべきです。必要ならextensionsフォルダからビルドできますし、他のサーバで必要ならファイルの複製ができます。 </p><pre class="programlisting">cd extensions
cd postgis
make clean
make
export PGUSER=postgres #overwrite psql variables
make check #to test before install
make install
# to test extensions
make check RUNTESTFLAGS=--extension</pre><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p><code class="code">make check</code>は、テスト実行のためにpsqlを使用し、psql環境変数を使用します。一般的なpsql環境変数で上書きすると便利なのが <code class="varname">PGUSER</code>,<code class="varname">PGPORT</code>, and <code class="varname">PGHOST</code>です。<a class="ulink" href="https://www.postgresql.org/docs/current/libpq-envars.html" target="_top">環境変数</a>を参照して下さい。 </p></td></tr></table></div><p>エクステンションファイルは、常に、OSに関係なく同じ版のPostGISでは同じです。PostGISバイナリを既にインストールしている限りは、エクステンションファイルをあるOSから別のものに複写して大丈夫です。 </p><p>開発用と異なる別のサーバでエクステンションを手動でインストールしたい場合は、サーバにない時に必要となる通常のPostGISのバイナリだけでなく、次のファイルをextensionsフォルダからPostgreSQLインストール先の<code class="filename">PostgreSQL / share / extension</code>フォルダに複写します。 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>指定されていない場合のインストールするエクステンションの版等の情報を示す制御ファイ<code class="filename">postgis.control, postgis_topology.control</code>。 </p></li><li class="listitem"><p>エクステンションごとの/sqlフォルダにあるファイル全て。<code class="filename">extensions/postgis/sql/*.sql</code>, <code class="filename">extensions/postgis_topology/sql/*.sql</code>はPostgreSQL share/extensionフォルダの最上位に複写する必要があることに注意して下さい。 </p></li></ul></div><p>以上を実行すると、PgAdmin -&gt; extensionで<code class="varname">postgis</code>, <code class="varname">postgis_topology</code>が有効なエクステンションとして見えます。</p><p>psqlを使う場合は、次のクエリを実行してエクステンションがインストールされていることを確認できます。</p><pre class="programlisting">SELECT name, default_version,installed_version
FROM pg_available_extensions WHERE name LIKE 'postgis%' or name LIKE 'address%';

             name             | default_version | installed_version
------------------------------+-----------------+-------------------
 address_standardizer         | 3.4.0         | 3.4.0
 address_standardizer_data_us | 3.4.0         | 3.4.0
 postgis                      | 3.4.0         | 3.4.0
 postgis_raster               | 3.4.0         | 3.4.0
 postgis_sfcgal               | 3.4.0         |
 postgis_tiger_geocoder       | 3.4.0         | 3.4.0
 postgis_topology             | 3.4.0         |
(6 rows)</pre><p>クエリを行ったデータベースにエクステンションがインストールされている場合は、<code class="varname">installed_version</code>カラムに記載が見えます。レコードが返ってこない場合は、PostGIS EXTENSIONがインストールされていないことになります。PgAdmin III 1.14以上では、データベースブラウザツリーの<code class="varname">extensions</code>セクションで提供されていて、右クリックでアップグレードまたアンインストールできます。</p><p>有効なエクステンションがある場合、pgAdminエクステンションインタフェースまたは次のSQLの実行によって、選択したデータベースにPostGISエクステンションをインストールできます。</p><pre class="programlisting">CREATE EXTENSION postgis;
CREATE EXTENSION postgis_raster;
CREATE EXTENSION postgis_sfcgal;
CREATE EXTENSION fuzzystrmatch; --needed for postgis_tiger_geocoder
--optional used by postgis_tiger_geocoder, or can be used standalone
CREATE EXTENSION address_standardizer;
CREATE EXTENSION address_standardizer_data_us;
CREATE EXTENSION postgis_tiger_geocoder;
CREATE EXTENSION postgis_topology;</pre><p>psqlでは、どの版が、どのスキーマにインストールされているかを見ることができます。 </p><pre class="programlisting">\connect mygisdb
\x
\dx postgis*</pre><pre class="screen">List of installed extensions
-[ RECORD 1 ]-------------------------------------------------
Name        | postgis
Version     | 3.4.0
Schema      | public
Description | PostGIS geometry, geography, and raster spat..
-[ RECORD 2 ]-------------------------------------------------
Name        | postgis_raster
Version     | 3.0.0dev
Schema      | public
Description | PostGIS raster types and functions
-[ RECORD 3 ]-------------------------------------------------
Name        | postgis_tiger_geocoder
Version     | 3.4.0
Schema      | tiger
Description | PostGIS tiger geocoder and reverse geocoder
-[ RECORD 4 ]-------------------------------------------------
Name        | postgis_topology
Version     | 3.4.0
Schema      | topology
Description | PostGIS topology spatial types and functions</pre><div class="warning"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[警告]" src="../images/warning.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>エクステンションのテーブル<code class="varname">spatial_ref_sys</code>, <code class="varname">layer</code>, <code class="varname">topology</code>は、明示的にバックアップできません。それぞれの<code class="varname">postgis</code>または<code class="varname">postgis_topology</code>エクステンションがバックアップされる時のみバックアップできます。これは、データベース全体のバックアップの時のみ行われます。PostGIS 2.0.1の時点では、データベースがバックアップされる際に、PostGISでパッケージ化されていないsridレコードのみバックアップされます。パッケージに入っているsridの変更は巡回せず、変更はそこにあるものと期待されます。PostGIS 2.0.1の時点では、データベースがバックアップされるときにPostGISに入っていないsridのレコードだけがバックアップされます。PostGISに入っていて後に変更されたsridの変更については巡回しません。問題が見られたら、チケットを発行して下さい。エクステンションテーブルの構造は<code class="code">CREATE EXTENSION</code>で生成されるので、バックアップを行いません。エクステンションの与えられた版と同じものであると仮定されます。この挙動は現在のPostgreSQL エクステンションモデルに組み込まれているため、これについては何もできません。</p></td></tr></table></div><p>素晴らしいエクステンション機構を使わずに3.4.0をインストールした場合には、それぞれのエクステンションが持つ関数をパッケージするためのコマンドを実行して、エクステンションに基づくように変更できます。PostgreSQL 13では、パッケージしない方法でのインストールは削除されましたので、PostgreSQL 13にアップグレードする前にエクステンションをビルドするように変更するべきです。 </p><pre class="programlisting">CREATE EXTENSION postgis FROM unpackaged;
CREATE EXTENSION postgis_raster FROM unpackaged;
CREATE EXTENSION postgis_topology FROM unpackaged;
CREATE EXTENSION postgis_tiger_geocoder FROM unpackaged;
</pre></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp270285472"></a>2.2.6. テスト</h3></div></div></div><p>PostGISのテストを行うには、次のコマンドを実行します。 </p><p>
		<span class="command"><strong>make check</strong></span>
	  </p><p>このコマンドで、実際のPostgreSQLデータベースに対して生成したライブラリを使用した、様々なチェックとレグレッションテストを行います。 </p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>PostgreSQL, GEOS または Proj を標準の位置にインストールしていない場合には、環境変数<code class="varname">LD_LIBRARY_PATH</code>に、ライブラリの位置を追加する必要があるかも知れません。 </p></td></tr></table></div><div class="caution"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="../images/caution.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>現在のところ<span class="command"><strong>make check</strong></span>は、チェックを行う際に 環境変数<code class="code">PATH</code>と<code class="code">PGPORT</code>によっています。コンフィギュレーションパラメータ<span class="command"><strong>--with-pgconfig</strong></span>を使って特定したPostgreSQLでは<span class="emphasis"><em>ありません</em></span>。PATHを編集して、コンフィギュレーションの際に検出したPostgreSQLと一致するようにして下さい。もしくは、間もなく襲ってくる頭痛の準備をしておいて下さい。 </p></td></tr></table></div><p>成功したなら、make checkで約500個のテストを生成します。結果は次のようなかんじになります (かなりの行を省略しています)。 </p><pre class="programlisting">CUnit - A unit testing framework for C - Version 2.1-3
     http://cunit.sourceforge.net/

        .
        .
        .

Run Summary:    Type  Total    Ran Passed Failed Inactive
              suites     44     44    n/a      0        0
               tests    300    300    300      0        0
             asserts   4215   4215   4215      0      n/a
Elapsed time =    0.229 seconds

        .
        .
        .

Running tests

        .
        .
        .

Run tests: 134
Failed: 0


-- if you build with SFCGAL

        .
        .
        .

Running tests

        .
        .
        .

Run tests: 13
Failed: 0

-- if you built with raster support

        .
        .
        .

Run Summary:    Type  Total    Ran Passed Failed Inactive
              suites     12     12    n/a      0        0
               tests     65     65     65      0        0
             asserts  45896  45896  45896      0      n/a


        .
        .
        .

Running tests

        .
        .
        .

Run tests: 101
Failed: 0

-- topology regress

.
.
.

Running tests

        .
        .
        .

Run tests: 51
Failed: 0

-- if you built --with-gui, you should see this too

     CUnit - A unit testing framework for C - Version 2.1-2
     http://cunit.sourceforge.net/

        .
        .
        .

Run Summary:    Type  Total    Ran Passed Failed Inactive
              suites      2      2    n/a      0        0
               tests      4      4      4      0        0
             asserts      4      4      4      0      n/a</pre><p><code class="varname">postgis_tiger_geocoder</code>と<code class="varname">address_standardizer</code>エクステンションは、現在は、標準的なPostgreSQLインストールチェックにのみ対応しています。これらをテストするには、次のようにします。ご注意: PostGISコードフォルダのルートでmake installを既に行っている場合には、make installは重要ではありません。</p><p>address_standardizer用: </p><pre class="programlisting">cd extensions/address_standardizer
make install
make installcheck
          </pre><p>出力は次のようなかんじになります。 </p><pre class="screen">============== dropping database "contrib_regression" ==============
DROP DATABASE
============== creating database "contrib_regression" ==============
CREATE DATABASE
ALTER DATABASE
============== running regression test queries        ==============
test test-init-extensions     ... ok
test test-parseaddress        ... ok
test test-standardize_address_1 ... ok
test test-standardize_address_2 ... ok

=====================
 All 4 tests passed.
=====================</pre><p>Tiger Geocodeを使う場合には、使用するPostgreSQLインスタンス内にPostGISとfuzzystrmatchのエクステンションが必要です。PostGISをaddress_standardizer機能付きでビルドした場合は、address_standardizerのテストも行います。 </p><pre class="programlisting">cd extensions/postgis_tiger_geocoder
make install
make installcheck
          </pre><p>出力は次のようなかんじになります。 </p><pre class="screen">============== dropping database "contrib_regression" ==============
DROP DATABASE
============== creating database "contrib_regression" ==============
CREATE DATABASE
ALTER DATABASE
============== installing fuzzystrmatch               ==============
CREATE EXTENSION
============== installing postgis                     ==============
CREATE EXTENSION
============== installing postgis_tiger_geocoder      ==============
CREATE EXTENSION
============== installing address_standardizer        ==============
CREATE EXTENSION
============== running regression test queries        ==============
test test-normalize_address   ... ok
test test-pagc_normalize_address ... ok

=====================
All 2 tests passed.
=====================</pre></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="idp270296992"></a>2.2.7. インストール</h3></div></div></div><p>PostGISをインストールするには、次のコマンドを実行します。 </p><p>
		<span class="command"><strong>make install</strong></span>
	  </p><p>これにより、PostGISのインストールファイルが、<span class="command"><strong>--prefix</strong></span>パラメータで指定した、適切なサブディレクトリに複写されます。次に特筆すべきサブディレクトリを示します。 </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>ローダとダンパのバイナリのインストール先は<code class="filename">[prefix]/bin</code>です。 </p></li><li class="listitem"><p><code class="filename">postgis.sql</code>などのSQLファイルのインストール先は<code class="filename">[prefix]/share/contrib</code>です。 </p></li><li class="listitem"><p>PostGISライブラリのインストール先は<code class="filename">[prefix]/lib</code>です。 </p></li></ul></div><p>先に<span class="command"><strong>make comments</strong></span>を実行して<code class="filename">postgis_comments.sql</code>, <code class="filename">raster_comments.sql</code>を生成していた場合は、次のコマンドを実行すると、これらのSQLファイルがインストールされます。 </p><p>
		<span class="command"><strong>make comments-install</strong></span>
	  </p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p><code class="filename">postgis_comments.sql</code>, <code class="filename">raster_comments.sql</code>, <code class="filename">topology_comments.sql</code>は、<span class="command"><strong>xsltproc</strong></span>の外部依存ができたので、通常のビルドとインストールから切り離されました。 </p></td></tr></table></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="installing_pagc_address_standardizer"></a>2.3. PAGC住所標準化ツールのインストールと使用</h2></div></div></div><p><code class="code">address_standardizer</code>エクステンションは、別途ダウンロードする必要がある別パッケージとしていました。PostGIS 2.2からは同梱されています。address_standardizeの追加情報、できること、および、コンフィギュレーション方法については、<a class="xref" href="Extras.html#Address_Standardizer" title="11.1. 住所標準化">「住所標準化」</a>をご覧下さい。</p><p>標準化エクステンションは、<a class="xref" href="Normalize_Address.html" title="Normalize_Address">Normalize_Address</a>の後継で、PostGISに入っているTigerジオコーダエクステンションに使うことができます。この場合の使い方については<a class="xref" href="postgis_installation.html#tiger_pagc_address_standardizing" title="2.4.2. TigerジオコーダをPostGISデータベースで有効にする: エクステンションを使用">「TigerジオコーダをPostGISデータベースで有効にする: エクステンションを使用」</a>を参照して下さい。また、ユーザ自身がつくるジオコーダの要素として使用したり、住所の比較を簡単にするために住所を標準化するために使うことができます。</p><p>住所標準化エクステンションはPCREに依存しています。PCREは多くのUNIX系システムにインストールされていますが、<a class="ulink" href="http://www.pcre.org" target="_top">http://www.pcre.org</a>から最新版をダウンロードできます。<a class="xref" href="postgis_installation.html#installation_configuration" title="2.2.3. コンフィギュレーション">「コンフィギュレーション」</a>の際にPCREを発見すると、住所標準化エクステンションが自動的にビルドされます。使用したいPCREのインストールが独自なものである場合は、configureに<code class="code">--with-pcredir=/path/to/pcre</code>を渡します。<code class="filename">/path/to/pcre</code>は、PCREのincludeとlibのあるルートフォルダです。</p><p>Windowsでは、PostGIS 2.1以上に住所標準化エクステンションが同梱されているので、コンパイルを行わずに、すぐに<code class="code">CREATE EXTENSION</code>に行くことができます。</p><p>インストールしたら、対象データベースに接続して次のSQLが実行できます。</p><pre class="programlisting">CREATE EXTENSION address_standardizer;</pre><p>次のテストでは、rules, gaz, lexテーブルは必要ありません。</p><pre class="programlisting">SELECT num, street, city, state, zip
 FROM parse_address('1 Devonshire Place PH301, Boston, MA 02109');</pre><p>出力は次のようになります。</p><pre class="screen">num |         street         |  city  | state |  zip
-----+------------------------+--------+-------+-------
 1   | Devonshire Place PH301 | Boston | MA    | 02109</pre></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="loading_extras_tiger_geocoder"></a>2.4. Tigerジオコーダのインストールとアップグレードとデータロード</h2></div></div></div><div class="toc"><dl class="toc"><dt><span class="sect2"><a href="postgis_installation.html#install_tiger_geocoder_extension">2.4.1. TigerジオコーダをPostGISデータベースで有効にする</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#tiger_pagc_address_standardizing">2.4.2. TigerジオコーダをPostGISデータベースで有効にする: エクステンションを使用</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#tiger_geocoder_required_tools">2.4.3. Tigerデータのロードに必要なツール</a></span></dt><dt><span class="sect2"><a href="postgis_installation.html#upgrade_tiger_geocoder">2.4.4. Tigerジオコーダとデータのアップグレード</a></span></dt></dl></div><p>Tigerジオコーダのような拡張機能はPostGISディストリビューションに同梱されていません。Tigerジオコーダエクステンションが無かったり、インストールしているものより新しい版のものが欲しい場合には、<a class="ulink" href="http://postgis.net/windows_downloads/" target="_top">Windows Unreleased Versions</a>でPostgreSQLの版に合ったパッケージにある<code class="filename">share/extension/postgis_tiger_geocoder.*</code>ファイルを使います。これらのパッケージはWindows用ですが、postgis_tige_geocoderエクステンションファイルは、SQLとPL/pgSQLだけですので、他のOSでも動作します。</p><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="install_tiger_geocoder_extension"></a>2.4.1. TigerジオコーダをPostGISデータベースで有効にする</h3></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>ここの説明では、お手持ちのPostgreSQLにpostgis_tiger_geocoderエクステンションがインストールされていると仮定します。</p></li><li class="listitem"><p>psql、pgAdminまたは他のツールでデータベースに接続して、次のSQLコマンドを実行します。既にPostGISを持っているデータベースにインストールする場合は、一つ目の手順は不要です。<code class="varname">fuzzystrmatch</code>エクステンションが既にインストールされている場合は、二つ目の手順は不要です。</p><pre class="programlisting">CREATE EXTENSION postgis;
CREATE EXTENSION fuzzystrmatch;
CREATE EXTENSION postgis_tiger_geocoder;
--this one is optional if you want to use the rules based standardizer (pagc_normalize_address)
CREATE EXTENSION address_standardizer;</pre><p>既にpostgis_tiger_geocoderエクステンションをインストールしていて、最新版に更新するだけの場合には、次を実行します。</p><pre class="programlisting">ALTER EXTENSION postgis UPDATE;
ALTER EXTENSION postgis_tiger_geocoder UPDATE;</pre><p>独自のエントリを生成した場合や、<code class="varname">tiger.loader_platform</code>と<code class="varname">tiger.loader_variables</code>に変更を加えた場合には、これらをアップデートしなければならないことがあります。</p></li><li class="listitem"><p>正しくインストールされたかを確認するために、インストール対象データベース内で次のSQLを実行します。</p><pre class="programlisting">SELECT na.address, na.streetname,na.streettypeabbrev, na.zip
        FROM normalize_address('1 Devonshire Place, Boston, MA 02109') AS na;</pre><p>出力は次のようになります。</p><pre class="screen">address | streetname | streettypeabbrev |  zip
---------+------------+------------------+-------
           1 | Devonshire | Pl               | 02109</pre></li><li class="listitem"><p><code class="varname">tiger.loader_platform</code>テーブルの、実行ファイルやサーバのパスを持つ新しいレコードを生成します。 </p><p><code class="code">sh</code>コンベンションのあとにdebbieというプロファイルを生成する例として、次のコマンドを実行します。</p><pre class="programlisting">INSERT INTO tiger.loader_platform(os, declare_sect, pgbin, wget, unzip_command, psql, path_sep,
                   loader, environ_set_command, county_process_command)
SELECT 'debbie', declare_sect, pgbin, wget, unzip_command, psql, path_sep,
           loader, environ_set_command, county_process_command
  FROM tiger.loader_platform
  WHERE os = 'sh';</pre><p>それから、<span class="emphasis"><em>declare_sect</em></span>カラム内のパスを編集して、Debbieのpg, unzip, shp2pgsql, psql他のパス位置に適応するようにします。</p><p><code class="varname">loader_platform</code>テーブルを編集しない場合は、一般的なアイテムの位置を持っているので、スクリプトが生成された後で、スクリプトを編集しなければなりません。</p></li><li class="listitem"><p>PostGIS 2.4.1からは、<code class="varname">ZTCA5</code> (Zip Code 5 digit Tabulation Area)のロード手順が変更され、有効になった時に<a class="xref" href="Loader_Generate_Nation_Script.html" title="Loader_Generate_Nation_Script">Loader_Generate_Nation_Script</a>の一部として現在のZCTA5データをロードするようになりました。デフォルトでは切られています。ロードにかなりの時間 (20から60分)が取られ、かなりのディスクスペースを占有するのに、そんなに頻繁には使わないためです。</p><p>有効にするには、次のようにします。</p><pre class="programlisting">UPDATE tiger.loader_lookuptables SET load = true WHERE table_name = 'zcta520';</pre><p>境界のフィルタが追加され、ちょうど境界内のZIPに制限された場合に、<a class="xref" href="Geocode.html" title="Geocode">Geocode</a>関数は、ZCTA5が存在するなら使います。<a class="xref" href="Reverse_Geocode.html" title="Reverse_Geocode">Reverse_Geocode</a>関数は、返された住所にZIPコードが無い場合に (しばしば高速道路での逆ジオコーディングで発生します)、これを使います。</p></li><li class="listitem"><p>サーバまたはローカル (サーバへのネットワーク接続が早い場合)のルートに<code class="filename">gisdata</code>というフォルダを作成します。このフォルダはTigerファイルがダウンロードされ、処理される場所です。サーバのルートにフォルダを作ると不幸になる場合や、単に他のフォルダに移したい場合には、<code class="varname">tiger.loader_variables</code>テーブルの<code class="varname">staging_fold</code>フィールドを編集します。</p></li><li class="listitem"><p><code class="filename">gisdata</code>フォルダ内にtempというフォルダを作成します。もしくは、<code class="varname">staging_fold</code>で示されたフォルダを作成します。ローダがダウンロードしたTigerデータを展開する場所です。</p></li><li class="listitem"><p>そして、SQL関数<a class="xref" href="Loader_Generate_Nation_Script.html" title="Loader_Generate_Nation_Script">Loader_Generate_Nation_Script</a>を実行して、独自のプロファイルの名前を使うか確認し、.shまたは.batファイルにスクリプトを複写します。たとえば、新しいプロファイルで国のロードを行う場合には、次のようにします。</p><pre class="programlisting">psql -c "SELECT Loader_Generate_Nation_Script('debbie')" -d geocoder -tA 
&gt; /gisdata/nation_script_load.sh</pre></li><li class="listitem"><p>生成された国データをロードするコマンドラインスクリプトを実行します。</p><pre class="programlisting">cd /gisdata
sh nation_script_load.sh</pre></li><li class="listitem"><p>国スクリプトを実行した後、<code class="code">tiger_data</code>スキーマに三つのテーブルが作られ、データが格納されています。次のクエリをpsqlかpgAdminから実行して、確認します。</p><pre class="programlisting">SELECT count(*) FROM tiger_data.county_all;</pre><pre class="screen">count
-------
  3235
(1 row)</pre><pre class="programlisting">SELECT count(*) FROM tiger_data.state_all;</pre><pre class="screen">count
-------
    56
(1 row)
</pre></li><li class="listitem"><p>デフォルトでは<code class="varname">bg</code>, <code class="varname">tract</code>, <code class="varname">tabblock20</code>に対応するテーブルはロードされません。ジオコーダはこれらのテーブルを使いませんが、一般に、人口統計に使います。州データのロードの一部としてロードするには、次の手続きを実行して有効にします。</p><pre class="programlisting">UPDATE tiger.loader_lookuptables SET load = true WHERE load = false AND lookup_name IN('tract', 'bg', 'tabblock20');</pre><p>もしくは、<a class="xref" href="Loader_Generate_Census_Script.html" title="Loader_Generate_Census_Script">Loader_Generate_Census_Script</a>を使って州のデータをロードした後に、これらのテーブルだけをロードできます。</p></li><li class="listitem"><p>データをロードしたい州ごとに、<a class="xref" href="Loader_Generate_Script.html" title="Loader_Generate_Script">Loader_Generate_Script</a>で州スクリプトを作ります。</p><div class="warning"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[警告]" src="../images/warning.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>国データのロードを完了する前に*州スクリプトを作ってはなりません*。州スクリプトは国スクリプトでロードされる国リストを利用するためです。</p></td></tr></table></div></li><li class="listitem"><pre class="programlisting">psql -c "SELECT Loader_Generate_Script(ARRAY['MA'], 'debbie')" -d geocoder -tA 
&gt; /gisdata/ma_load.sh</pre></li><li class="listitem"><p>生成されたコマンドラインスクリプトを実行します。</p><pre class="programlisting">cd /gisdata
sh ma_load.sh</pre></li><li class="listitem"><p>全てのデータのロードが完了するか中断ポイントに達した後に、全てのtigerテーブルに対してanalyzeを実行して、(継承されたものも含めて)状態を更新するのは良いことです。</p><pre class="programlisting">SELECT install_missing_indexes();
vacuum (analyze, verbose) tiger.addr;
vacuum (analyze, verbose) tiger.edges;
vacuum (analyze, verbose) tiger.faces;
vacuum (analyze, verbose) tiger.featnames;
vacuum (analyze, verbose) tiger.place;
vacuum (analyze, verbose) tiger.cousub;
vacuum (analyze, verbose) tiger.county;
vacuum (analyze, verbose) tiger.state;
vacuum (analyze, verbose) tiger.zip_lookup_base;
vacuum (analyze, verbose) tiger.zip_state;
vacuum (analyze, verbose) tiger.zip_state_loc;</pre></li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="tiger_pagc_address_standardizing"></a>2.4.2. TigerジオコーダをPostGISデータベースで有効にする: エクステンションを使用</h3></div></div></div><p>皆さんが問題と思われるの多くのことのひとつに、ジオコーディング前の準備に住所を正規化する関数<a class="xref" href="Normalize_Address.html" title="Normalize_Address">Normalize_Address</a>があります。住所正規化は万全と言うにはほど遠く、パッチをあてようとすると膨大な資源を費やします。よって、より良い住所標準化エンジンを持つ他のプロジェクトに統合しました。この新しい住所標準化を使うには、<a class="xref" href="postgis_installation.html#installing_pagc_address_standardizer" title="2.3. PAGC住所標準化ツールのインストールと使用">「PAGC住所標準化ツールのインストールと使用」</a>で記述するようにエクステンションをコンパイルし、使用するデータベースにインストールします。</p><p>このエクステンションを<code class="code">postgis_tiger_geocoder</code>をインストールしているデータベースにインストールすると、<a class="xref" href="Pagc_Normalize_Address.html" title="Pagc_Normalize_Address">Pagc_Normalize_Address</a>を、<a class="xref" href="Normalize_Address.html" title="Normalize_Address">Normalize_Address</a>の代わりに使うことができます。このエクステンションはTigerジオコーダからは見えないので、国際的な住所といった他のデータソースでも使えます。Tigerジオコーダエクステンションは、その版の<a class="xref" href="rulestab.html" title="rules table">rules table</a> (<code class="code">tiger.pagc_rules</code>), <a class="xref" href="gaztab.html" title="gaz table">gaz table</a> (<code class="code">tiger.pagc_gaz</code>), <a class="xref" href="lextab.html" title="lex table">lex table</a> (<code class="code">tiger.pagc_lex</code>)を同梱しています。これらは、必要に応じて標準化の改善のために追加や更新ができます。</p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="tiger_geocoder_required_tools"></a>2.4.3. Tigerデータのロードに必要なツール</h3></div></div></div><p>ロードプロセスによって、米センサスウェブサイトから個々の国ファイル、リクエストされた州のデータをダウンロードし、ファイルを展開し、個別の州をそれぞれの州テーブルの集合にロードします。各州のテーブルは、<code class="varname">tiger</code>スキーマで定義されたテーブルを継承しているので、これらのテーブルに対して全てのデータにアクセスするためのクエリを出すことができますし、州の再読み込みが必要となったり、州が必要ない場合には、<a class="xref" href="Drop_State_Tables_Generate_Script.html" title="Drop_State_Tables_Generate_Script">Drop_State_Tables_Generate_Script</a>で、いつでも州テーブルの集合を削除するクエリを出すことができます。</p><p>データのロードを可能にするためには次のツールが必要です。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>センサスウェブサイトから取得するZIPファイルを展開するツール。</p><p>Unix系システムでは、<code class="varname">unzip</code>実行ファイルです。通常は、ほとんどのUnix系プラットフォームで既にインストールされています。</p><p>Windowsでは7-zipです。<a class="ulink" href="http://www.7-zip.org/" target="_top">http://www.7-zip.org/</a>からダウンロードできる無償の圧縮解凍ツールです。 </p></li><li class="listitem"><p><code class="filename">shp2pgsql</code>コマンド。PostGISインストール時にデフォルトでインストールされます。</p></li><li class="listitem"><p><code class="filename">wget</code>コマンド。通常はほとんどのUnix/Linuxシステムにインストールされている、ウェブ取得ツールです。</p><p>Windows用については、コンパイル済みのバイナリを<a class="ulink" href="http://gnuwin32.sourceforge.net/packages/wget.htm" target="_top">http://gnuwin32.sourceforge.net/packages/wget.htm</a>から取得できます。 </p></li></ul></div><p>tiger_2010からアップグレードする場合には、最初に<a class="xref" href="Drop_Nation_Tables_Generate_Script.html" title="Drop_Nation_Tables_Generate_Script">Drop_Nation_Tables_Generate_Script</a>を生成、実行する必要があります。どの州データもロードする前に、<a class="xref" href="Loader_Generate_Nation_Script.html" title="Loader_Generate_Nation_Script">Loader_Generate_Nation_Script</a>で全国的なデータをロードする必要があります。これによりローダスクリプトが生成されます。(以前の年のTiger国勢調査データからの)アップグレードや新規インストールで行う<a class="xref" href="Loader_Generate_Nation_Script.html" title="Loader_Generate_Nation_Script">Loader_Generate_Nation_Script</a>の回数は1回です。</p><p>州データをロードするには、<a class="xref" href="Loader_Generate_Script.html" title="Loader_Generate_Script">Loader_Generate_Script</a>を参照して、手持ちのプラットフォームで動作する、求める州データをロードするデータロードスクリプトを生成します。州データはひとつずつダウンロードできることに注意して下さい。一度に必要な州の全てについてデータをロードする必要はありません。必要なだけダウンロードできます。</p><p>求める州データをロードした後は、<a class="xref" href="Install_Missing_Indexes.html" title="Install_Missing_Indexes">Install_Missing_Indexes</a>に示すように、</p><pre class="programlisting">SELECT install_missing_indexes();</pre><p>を実行するようにして下さい。</p><p>行うべきことができたかをテストするために、<a class="xref" href="Geocode.html" title="Geocode">Geocode</a>を使用する州の中の住所についてジオコーダを実行してみます。 </p></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="upgrade_tiger_geocoder"></a>2.4.4. Tigerジオコーダとデータのアップグレード</h3></div></div></div><p>まずpostgis_tiger_geocoderエクステンションを次のようにアップグレードします。</p><pre class="programlisting">ALTER EXTENSION postgis_tiger_geocoder UPDATE;</pre><p>次に、全ての国テーブルを削除し、新しい国テーブルをロードします。<a class="xref" href="Drop_Nation_Tables_Generate_Script.html" title="Drop_Nation_Tables_Generate_Script">Drop_Nation_Tables_Generate_Script</a>に詳細がある通り、このSQLステートメントを使った削除スクリプトを生成します。</p><pre class="programlisting">SELECT drop_nation_tables_generate_script();</pre><p>生成した削除SQLステートメントを実行します。</p><p><a class="xref" href="Loader_Generate_Nation_Script.html" title="Loader_Generate_Nation_Script">Loader_Generate_Nation_Script</a>に詳細がある通り、このSELECTステートメントを使った削除スクリプトを生成します。</p><p><span class="bold"><strong>Windows向け</strong></span></p><pre class="programlisting">SELECT loader_generate_nation_script('windows'); </pre><p><span class="bold"><strong>Unix/Linux向け</strong></span></p><pre class="programlisting">SELECT loader_generate_nation_script('sh');</pre><p>生成スクリプトの実行方法に関する説明は、<a class="xref" href="postgis_installation.html#install_tiger_geocoder_extension" title="2.4.1. TigerジオコーダをPostGISデータベースで有効にする">「TigerジオコーダをPostGISデータベースで有効にする」</a>を参照して下さい。これは一度だけ実行する必要があります。</p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注記]" src="../images/note.png"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>州テーブルで複数年分が混ざっていてもよく、また州ごとに分割してアップグレードできます。一つの州をアップグレードする前に、<a class="xref" href="Drop_State_Tables_Generate_Script.html" title="Drop_State_Tables_Generate_Script">Drop_State_Tables_Generate_Script</a>を使って、以前の年の州テーブルを削除する必要があります。</p></td></tr></table></div></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="idp270423840"></a>2.5. 共通の問題</h2></div></div></div><p>インストールやアップグレードが思うようにいかない時にチェックすることがいくつかあります。 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>PostgreSQL 12以上をインストールしているか、実行中のPostgreSQLと同じ版のソースでコンパイルしているか、をチェックします。(Linuxの)ディストリビューションによって既にPostgreSQLがインストールされている時や、 PostgreSQLを以前にインストールして忘れた場合に、 混乱が発生することがあります。PostGISはPostgreSQL 12以上で動作します。古い版のものを使った場合には、おかしな予想外のエラーメッセージが表示されます。実行中のPostgreSQLの版をチェックするには、psqlを使ってデータベースを接続して、次のクエリを実行して下さい。 </p><pre class="programlisting">SELECT version();</pre><p>RPMベースのディストリビューションを実行している場合、 プリインストールされたパッケージが存在するかのチェックは、<span class="command"><strong>rpm</strong></span> コマンドを使って<span class="command"><strong>rpm -qa | grep postgresql</strong></span>でチェックできます。 </p></li><li class="listitem"><p>アップグレードに失敗する場合、既にPostGISがインストールされているデータベースにリストアしているか確認して下さい。</p><pre class="programlisting">SELECT postgis_full_version();</pre></li></ol></div><p>また、コンフィギュアが正しくPostgreSQL、Proj4ライブラリ、GEOSライブラリのインストール先を検出したかチェックして下さい。 </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>コンフィギュアからの出力で<code class="filename">postgis_config.h</code>ファイルが作られます。<code class="varname">POSTGIS_PGSQL_VERSION</code>、<code class="varname">POSTGIS_PROJ_VERSION</code>および<code class="varname">POSTGIS_GEOS_VERSION</code>変数が正しくセットされたかをチェックして下さい。 </p></li></ol></div></div></div><div class="navfooter"><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="postgis_introduction.html">戻る</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="postgis_administration.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">第1章 導入 </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 第3章 PostGIS管理</td></tr></table></div></body></html>
